{% extends "base.html" %}
{% block title %}Manage Users{% endblock %}

{% block content %}

<!-- ================= HEADER ================= -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="fw-bold mb-0">จัดการผู้ใช้งาน (Manage Users)</h3>
  <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
    + เพิ่มผู้ใช้งาน
  </button>
</div>

<!-- ================= MESSAGES ================= -->
{% for m in messages %}
  <div class="alert alert-{{ m.tags }} alert-dismissible fade show">
    {{ m }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
{% endfor %}

<!-- ================= FILTER ================= -->
<div class="row g-2 mb-3 align-items-end">

  <div class="col-md-4">
    <label class="form-label mb-1">ค้นหา</label>
    <input type="search"
           id="customSearch"
           class="form-control form-control-sm"
           placeholder="Username / ชื่อ">
  </div>

  <div class="col-md-2">
    <label class="form-label mb-1">Role</label>
    <select id="roleFilter" class="form-select form-select-sm">
      <option value="">ทุก Role</option>
      {% for r in roles %}
        <option value="{{ r.role_name }}">{{ r.role_name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label mb-1">แผนก</label>
    <select id="departmentFilter" class="form-select form-select-sm">
      <option value="">ทุกแผนก</option>
      {% for d in departments %}
        <option value="{{ d.department_name }}">{{ d.department_name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <label class="form-label mb-1">สถานะ</label>
    <select id="activeFilter" class="form-select form-select-sm">
      <option value="">ทั้งหมด</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
    </select>
  </div>

  <div class="col-md-1">
    <button id="resetFilter" class="btn btn-outline-secondary btn-sm w-100">
      รีเซ็ต
    </button>
  </div>

</div>

<!-- ================= TABLE ================= -->
<div class="card shadow-sm">
  <div class="card-body p-2">

    <table id="userTable" class="table table-hover align-middle">
      <thead class="table-light">
        <tr class="text-center">
          <th>ID</th>
          <th>ERP</th>
          <th>Username</th>
          <th>ชื่อ-นามสกุล</th>
          <th>แผนก</th>
          <th>Role</th>
          <th>Active</th>
          <th style="width:80px;">บันทึก</th>
        </tr>
      </thead>

      <tbody>
      {% for u in users %}
        <tr>
          <td class="text-center">{{ u.id }}</td>
          <td class="text-center">{{ u.erp_user_id|default:"-" }}</td>
          <td>{{ u.username }}</td>
          <td>{{ u.full_name }}</td>
          <td>{{ u.department_name|default:"-" }}</td>
          <td>{{ u.role_name }}</td>
          <td class="text-center">
            <!-- ค่า default = inactive -->
            <input type="hidden"
                  name="is_active"
                  value="0"
                  form="form-{{ u.id }}">

            <!-- ถ้า checked จะส่งค่า 1 มาทับ -->
            <input class="form-check-input"
                  type="checkbox"
                  name="is_active"
                  value="1"
                  form="form-{{ u.id }}"
                  {% if u.is_active %}checked{% endif %}>
          </td>

          <td class="text-center">
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_user">
              <input type="hidden" name="user_id" value="{{ u.id }}">
              <button class="btn btn-sm btn-primary">บันทึก</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

  </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
$(document).ready(function () {

  const table = $('#userTable').DataTable({
    pageLength: 10,
    lengthChange: false,
    ordering: true,
    searching: true,
    dom: 'tip', // ❌ ไม่ใช้ search ของ DataTables
    language: {
      info: "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
      zeroRecords: "ไม่พบข้อมูล",
      paginate: {
        previous: "ก่อนหน้า",
        next: "ถัดไป"
      }
    }
  });

  // ================= CUSTOM FILTER =================
  $.fn.dataTable.ext.search.push(function (settings, data) {

    const keyword    = $('#customSearch').val().toLowerCase();
    const role       = $('#roleFilter').val().toLowerCase();
    const department = $('#departmentFilter').val().toLowerCase();
    const active     = $('#activeFilter').val();

    const username = (data[2] || '').toLowerCase();
    const fullname = (data[3] || '').toLowerCase();
    const dept     = (data[4] || '').toLowerCase();
    const rowRole  = (data[5] || '').toLowerCase();
    const status   = (data[6] || '').toLowerCase();

    const matchText =
      !keyword ||
      username.includes(keyword) ||
      fullname.includes(keyword);

    const matchRole =
      !role || rowRole === role;

    const matchDept =
      !department || dept === department;

    const matchActive =
      !active ||
      (active === 'active' && status.includes('active')) ||
      (active === 'inactive' && status.includes('inactive'));

    return matchText && matchRole && matchDept && matchActive;
  });

  $('#customSearch').on('keyup', () => table.draw());
  $('#roleFilter').on('change', () => table.draw());
  $('#departmentFilter').on('change', () => table.draw());
  $('#activeFilter').on('change', () => table.draw());

  $('#resetFilter').on('click', function () {
    $('#customSearch').val('');
    $('#roleFilter').val('');
    $('#departmentFilter').val('');
    $('#activeFilter').val('');
    table.draw();
  });

});
</script>
{% endblock %}
