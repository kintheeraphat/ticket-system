{% extends "base.html" %}
{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- ================= HEADER ================= -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">จัดการผู้ใช้งาน (Manage Users)</h3>
    </div>

    <!-- ================= FILTER BAR ================= -->
    <div class="row g-3 mb-3">

        <!-- SEARCH -->
        <div class="col-md-4">
            <label class="form-label fw-bold">ค้นหาผู้ใช้งาน</label>
            <input
                type="text"
                id="userSearch"
                class="form-control"
                placeholder="ค้นหา ID / ERP ID / Username / ชื่อ"
            >
        </div>

        <!-- ROLE FILTER -->
        <div class="col-md-3">
            <label class="form-label fw-bold">Role</label>
            <select id="roleFilter" class="form-select">
                <option value="">ทั้งหมด</option>
                {% for r in roles %}
                    <option value="{{ r.role_name|lower }}">
                        {{ r.role_name }}
                    </option>
                {% endfor %}
            </select>
        </div>

    </div>

    <!-- ================= TABLE ================= -->
    <div class="table-responsive">
        <table
            id="usersTable"
            class="table table-bordered table-hover align-middle"
        >
            <thead class="table-light">
                <tr class="text-center">
                    <th>ID</th>
                    <th>ERP ID</th>
                    <th>Username</th>
                    <th>ชื่อ-นามสกุล</th>
                    <th>Role</th>
                    <th>Active</th>
                    <th>จัดการ</th>
                </tr>
            </thead>
            <tbody>

            {% for u in users %}
                <tr class="user-row"
                    data-id="{{ u.id }}"
                    data-erp="{{ u.erp_user_id|default:'' }}"
                    data-username="{{ u.username|lower }}"
                    data-name="{{ u.full_name|lower }}"
                    data-role="{{ u.role_name|lower }}"
                >
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="user_id" value="{{ u.id }}">

                        <td class="text-center">{{ u.id }}</td>
                        <td class="text-center">{{ u.erp_user_id|default:"-" }}</td>
                        <td>{{ u.username }}</td>
                        <td>{{ u.full_name }}</td>

                        <td>
                            <select name="role_id" class="form-select form-select-sm">
                                {% for r in roles %}
                                    <option value="{{ r.id }}"
                                        {% if r.role_name == u.role_name %}selected{% endif %}>
                                        {{ r.role_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </td>

                        <td class="text-center">
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    name="is_active"
                                    value="1"
                                    {% if u.is_active %}checked{% endif %}
                                >
                            </div>
                        </td>

                        <td class="text-center">
                            <button type="submit" class="btn btn-sm btn-primary">
                                บันทึก
                            </button>
                        </td>
                    </form>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        ไม่พบผู้ใช้งาน
                    </td>
                </tr>
            {% endfor %}

            </tbody>
        </table>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function () {

    // ================= DATATABLE =================
    const table = $('#usersTable').DataTable({
        paging: true,
        ordering: true,
        info: true,

        searching: false,   // ❌ ปิด search ของ DataTables
        lengthChange: false,

        pageLength: 10,
        language: {
            info: "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
            infoEmpty: "ไม่พบข้อมูล",
            paginate: {
                previous: "ก่อนหน้า",
                next: "ถัดไป"
            }
        }
    });

    // ================= CUSTOM FILTER =================
    const searchInput = document.getElementById("userSearch");
    const roleFilter  = document.getElementById("roleFilter");

    function applyFilter() {
        const keyword = searchInput.value.toLowerCase().trim();
        const role    = roleFilter.value.toLowerCase();

        document.querySelectorAll(".user-row").forEach(row => {

            const text = (
                row.dataset.id + " " +
                row.dataset.erp + " " +
                row.dataset.username + " " +
                row.dataset.name
            );

            const textMatch = text.includes(keyword);
            const roleMatch = !role || row.dataset.role === role;

            row.style.display = (textMatch && roleMatch) ? "" : "none";
        });
    }

    searchInput.addEventListener("input", applyFilter);
    roleFilter.addEventListener("change", applyFilter);

});
</script>
{% endblock %}
