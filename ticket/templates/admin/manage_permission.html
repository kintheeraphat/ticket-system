{% extends "base.html" %}
{% block title %}Permission Control Center{% endblock %}

{% block content %}
<div class="container-fluid py-4">
<div class="row g-4">

<!-- ================= LEFT : USER PANEL ================= -->
<div class="col-lg-3">

  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-header bg-white border-0">
      <h6 class="fw-bold mb-0">Users</h6>
    </div>

    <div class="card-body pt-2">

      <input type="text"
             id="userSearch"
             class="form-control form-control-sm mb-3"
             placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ user">

      <div class="user-scroll">

        {% for user in users %}
        <form method="get" class="mb-1 user-item"
              data-search="{{ user.username|lower }}">
          <input type="hidden" name="user_id" value="{{ user.id }}">

          <button type="submit"
                  class="btn w-100 text-start
                  {% if selected_user_id == user.id|stringformat:'s' %}
                      btn-primary
                  {% else %}
                      btn-light
                  {% endif %}">
              {{ user.username }}
          </button>
        </form>
        {% endfor %}

      </div>
    </div>
  </div>
</div>


<!-- ================= RIGHT : PERMISSION PANEL ================= -->
<div class="col-lg-9">

{% if selected_user_id %}

<div class="card shadow-sm border-0 rounded-4">

  <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
    <div>
      <h5 class="fw-bold mb-0">Permission Control</h5>
      <small class="text-muted">User ID: {{ selected_user_id }}</small>
    </div>

    <span class="badge bg-success rounded-pill px-3">
      Enabled: <span id="enabledCount">0</span>
    </span>
  </div>

  <div class="card-body">

    <!-- üî• ROLE PRESET BUTTONS -->
    <div class="mb-3 d-flex gap-2 flex-wrap">

      <button type="button"
              class="btn btn-danger btn-sm"
              onclick="setAdminPermissions()">
        üî¥ Admin (All Access)
      </button>

      <button type="button"
              class="btn btn-primary btn-sm"
              onclick="setUserPermissions()">
        üîµ User / Manager
      </button>

      <button type="button"
              class="btn btn-outline-secondary btn-sm"
              onclick="clearPermissions()">
        ‚ùå Clear
      </button>

    </div>

    <!-- SEARCH PERMISSION -->
    <div class="mb-3">
      <input type="text"
             id="permissionSearch"
             class="form-control"
             placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ permission">
    </div>

    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="user_id" value="{{ selected_user_id }}">

      <div class="permission-scroll">

        {% for perm in permissions %}
        <div class="permission-row d-flex justify-content-between align-items-center py-2 px-3 border-bottom"
             data-search="{{ perm.code|lower }} {{ perm.url_name|lower }} {{ perm.description|lower }}">

          <div>
            <div class="fw-semibold small">{{ perm.code }}</div>
            <div class="text-muted small">{{ perm.url_name }}</div>
          </div>

          <div class="form-check form-switch">
            <input class="form-check-input permission-checkbox"
                   type="checkbox"
                   name="permissions"
                   value="{{ perm.id }}"
                   {% if perm.id in user_permission_ids %}checked{% endif %}>
          </div>

        </div>
        {% endfor %}

      </div>

      <div class="text-end mt-4">
        <button type="submit" class="btn btn-success px-4">
          üíæ Save
        </button>
      </div>

    </form>
  </div>
</div>

{% else %}

<div class="card shadow-sm border-0 rounded-4">
  <div class="card-body text-center text-muted py-5">
    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
  </div>
</div>

{% endif %}

</div>
</div>
</div>


<style>
.user-scroll {
  max-height: 500px;
  overflow-y: auto;
}
.permission-scroll {
  max-height: 600px;
  overflow-y: auto;
}
</style>


<script>

/* ================= USER SEARCH ================= */
document.getElementById("userSearch").addEventListener("keyup", function(){
  let value = this.value.toLowerCase();
  document.querySelectorAll(".user-item").forEach(function(item){
    let text = item.getAttribute("data-search");
    item.style.display = text.includes(value) ? "" : "none";
  });
});


/* ================= ENABLED COUNT ================= */
function updateEnabledCount(){
  let count = document.querySelectorAll(".permission-checkbox:checked").length;
  document.getElementById("enabledCount").innerText = count;
}

document.addEventListener("change", function(e){
  if(e.target.classList.contains("permission-checkbox")){
    updateEnabledCount();
  }
});

updateEnabledCount();


/* ================= PERMISSION SEARCH ================= */
document.getElementById("permissionSearch")?.addEventListener("keyup", function(){
  let value = this.value.toLowerCase();
  document.querySelectorAll(".permission-row").forEach(function(row){
    let text = row.getAttribute("data-search");
    row.style.display = text.includes(value) ? "" : "none";
  });
});


/* ================= ROLE PRESETS ================= */

function setAdminPermissions(){
  document.querySelectorAll(".permission-checkbox")
      .forEach(cb => cb.checked = true);
  updateEnabledCount();
}


function setUserPermissions(){

  const allowedKeywords = [
    "create_ticket",
    "tickets_list",
    "detail",
    "delete_ticket",
    "edit_ticket"
  ];

  document.querySelectorAll(".permission-row").forEach(row => {

      const searchText = row.getAttribute("data-search");
      const checkbox = row.querySelector(".permission-checkbox");

      checkbox.checked = false;

      allowedKeywords.forEach(key => {
          if(searchText.includes(key)){
              checkbox.checked = true;
          }
      });

  });

  updateEnabledCount();
}


function clearPermissions(){
  document.querySelectorAll(".permission-checkbox")
      .forEach(cb => cb.checked = false);
  updateEnabledCount();
}

</script>

{% endblock %}
