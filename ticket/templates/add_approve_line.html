{% extends "base.html" %}
{% block title %}ตั้งค่าสายอนุมัติ | Approval Flow{% endblock %}

{% block content %}
<main class="main-content">

    <h4 class="fw-bold mb-3">ตั้งค่าสายอนุมัติ (Approval Flow)</h4>

    <div class="card shadow-sm">
        <div class="card-body">

            <form method="post">
                {% csrf_token %}

                <!-- Ticket Type -->
                <div class="mb-3">
                    <label class="form-label">ประเภทคำขอ</label>
                    <select name="ticket_type_id" class="form-select" required>
                        <option value="">-- เลือกประเภทคำขอ --</option>
                        {% for t in ticket_types %}
                        <option value="{{ t.id }}">{{ t.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Team -->
                <div class="mb-3">
                    <label class="form-label">ทีมอนุมัติ</label>
                    <select name="team_id" class="form-select" required>
                        <option value="">-- เลือกทีม --</option>
                        {% for t in teams %}
                        <option value="{{ t.id }}">
                            {{ t.name }} ({{ t.dept_name }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <hr>

                <!-- Levels -->
                <h6 class="fw-semibold">ลำดับผู้อนุมัติ (Level 1 → 5)</h6>

                <div id="approver-list">

                    <!-- Level 1 -->
                    <div class="row g-2 mb-2 approver-row">
                        <div class="col-md-10">
                            <input type="text" class="form-control user-search" placeholder="พิมพ์ชื่อ user..." onkeyup="filterUsers(this)">
                            <select name="user_ids[]" class="form-select user-select mt-1" required>
                                <option value="">-- เลือกผู้อนุมัติ (Level 1) --</option>
                                {% for u in users %}
                                <option value="{{ u.id }}">{{ u.full_name }} ({{ u.username }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-success w-100" onclick="addRow()">+</button>
                        </div>
                    </div>

                </div>

                <div class="mt-4 text-end">
                    <button class="btn btn-primary px-4">
                        บันทึกสายอนุมัติ
                    </button>
                </div>

            </form>

        </div>
    </div>

</main>

<script>
function addRow(){
    const container = document.getElementById("approver-list");
    const count = container.children.length + 1;

    if(count > 5){
        alert("สูงสุด 5 Level เท่านั้น");
        return;
    }

    const row = document.createElement("div");
    row.className = "row g-2 mb-2 approver-row";
    row.innerHTML = `
        <div class="col-md-10">
            <input type="text" class="form-control user-search" placeholder="พิมพ์ชื่อ user..." onkeyup="filterUsers(this)">
            <select name="user_ids[]" class="form-select user-select mt-1" required>
                <option value="">-- เลือกผู้อนุมัติ (Level ${count}) --</option>
                {% for u in users %}
                <option value="{{ u.id }}">{{ u.full_name }} ({{ u.username }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger w-100" onclick="this.closest('.approver-row').remove()">ลบ</button>
        </div>
    `;
    container.appendChild(row);
}

function filterUsers(input){
    const keyword = input.value.toLowerCase();
    const select = input.nextElementSibling;
    const options = select.options;

    for(let i=0;i<options.length;i++){
        const text = options[i].text.toLowerCase();
        options[i].style.display = text.includes(keyword) ? '' : 'none';
    }
}
</script>

{% endblock %}
