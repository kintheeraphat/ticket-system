{% extends "base.html" %}
{% load static %}

{% block title %}ตั้งค่าสายอนุมัติ{% endblock %}

{% block content %}

<main>
<div class="form-card">

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-bold mb-1">ตั้งค่าสายอนุมัติ</h4>
        <div class="text-muted" style="font-size:0.85rem">Approval Flow Configuration</div>
    </div>
    <span class="status-badge bg-primary-soft">SYSTEM SETTING</span>
</div>

<!-- MESSAGE -->
{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} shadow-sm rounded-3">{{ message }}</div>
    {% endfor %}
{% endif %}

<!-- FILTER PANEL -->
<div class="filter-panel mb-4">
    <div class="grid-2">
        <div>
            <label class="form-label">เอกสาร</label>
            <select class="form-select" name="document_id" id="documentSelect" form="approveForm" required>
                <option value="">-- เลือกเอกสาร --</option>
                {% for d in documents %}
                <option value="{{ d.id }}">{{ d.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="form-label">Team (จากผู้ใช้งาน)</label>
            <input type="text" class="form-control bg-light" value="{{ team.name }}" readonly>
            <input type="hidden" name="team_id" value="{{ team.id }}" form="approveForm">
        </div>
    </div>
</div>

<!-- TABLE -->
<form method="post" id="approveForm">
    {% csrf_token %}

    <div class="dashboard-table">
        <h4 class="mb-3">Approval Flow</h4>

        <div class="table-responsive">
            <table class="table table-hover align-middle" id="approveTable">
                <thead>
                    <tr class="text-center">
                        <th width="8%">Level</th>
                        <th>ผู้อนุมัติ</th>
                        <th width="12%">จัดการ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="hover-row animate-fade-in">
                        <td class="text-center">
                            <span class="badge bg-light">1</span>
                        </td>
                        <td>
                            <select name="approver[]" class="form-select" required>
                                <option value="">-- เลือกผู้อนุมัติ --</option>
                                {% for u in users %}
                                <option value="{{ u.id }}">{{ u.full_name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="text-center">
                            <button type="button" class="action-btn" onclick="removeRow(this)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ACTIONS -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <button type="button" class="btn btn-primary" onclick="addRow()">
                + เพิ่มระดับอนุมัติ
            </button>

            <button type="submit" class="btn btn-success">
                บันทึกสายอนุมัติ
            </button>
        </div>

    </div>
</form>

</div>
</main>

<script>
function addRow(){
    const table = document.getElementById('approveTable').getElementsByTagName('tbody')[0];
    const rowCount = table.rows.length + 1;

    const row = table.insertRow();
    row.classList.add('hover-row','animate-fade-in');

    row.innerHTML = `
        <td class=\"text-center\">
            <span class=\"badge bg-light\">${rowCount}</span>
        </td>
        <td>
            <select name=\"approver[]\" class=\"form-select\" required>
                <option value=\"\">-- เลือกผู้อนุมัติ --</option>
                {% for u in users %}
                <option value=\"{{ u.id }}\">{{ u.full_name }}</option>
                {% endfor %}
            </select>
        </td>
        <td class=\"text-center\">
            <button type=\"button\" class=\"action-btn\" onclick=\"removeRow(this)\">
                <i class=\"bi bi-trash\"></i>
            </button>
        </td>
    `;
}

function removeRow(btn){
    const row = btn.closest('tr');
    row.remove();

    const rows = document.querySelectorAll('#approveTable tbody tr');
    rows.forEach((r,i)=>{
        r.children[0].innerHTML = `<span class=\"badge bg-light\">${i+1}</span>`;
    });
}
</script>

{% endblock %}
