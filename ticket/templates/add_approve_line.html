{% extends "base.html" %}
{% load static %}

{% block title %}‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏¢‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥{% endblock %}

{% block content %}
<div class="container-fluid approval-page">

  <div class="row g-4">

    <!-- ================= LEFT : CREATE FLOW ================= -->
    <div class="col-12 col-lg-4">

      <div class="card shadow-sm sticky-top" style="top:20px;">
        <div class="card-header">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-plus-circle me-1 text-primary"></i>
            ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏¢‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
          </h5>
          <small class="text-muted">Approval Flow Configuration</small>
        </div>

        <div class="card-body">

          {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">
            {{ message }}
          </div>
          {% endfor %}

          <!-- CATEGORY / TEAM -->
          <div class="row mb-3">
            <div class="col-12 mb-3">
              <label class="form-label">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Category)</label>
              <select class="form-select" name="category_id" form="approveForm" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ --</option>
                {% for c in categories %}
                <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">Team</label>
              <select class="form-select" name="team_id" form="approveForm" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏° --</option>
                {% for t in teams %}
                <option value="{{ t.id }}">{{ t.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- FORM -->
          <form method="post" id="approveForm">
            {% csrf_token %}

            <div class="table-responsive overflow-visible">
              <table class="table table-hover align-middle" id="approveTable">
                <thead class="table-light">
                  <tr class="text-center">
                    <th width="20%">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                    <th>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
                    <th width="10%"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="text-center">
                      <span class="badge bg-light">1</span>
                    </td>
                    <td>
                      <div class="position-relative">
                        <input type="text"
                               class="form-control approver-input"
                               placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥..."
                               autocomplete="off">
                        <input type="hidden" name="approver[]" class="approver-id">
                        <div class="autocomplete-box"></div>
                      </div>
                    </td>
                    <td></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="d-flex justify-content-between mt-3">
              <button type="button" class="btn btn-outline-primary" onclick="addRow()">
                + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö
              </button>
              <button type="submit" class="btn btn-success px-4">
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
              </button>
            </div>

          </form>
        </div>
      </div>

    </div>

    <!-- ================= RIGHT : FLOW LIST ================= -->
    <div class="col-12 col-lg-8">

      <!-- FILTER BAR -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="row g-3">

            <div class="col-md-6">
              <label class="form-label fw-bold">
                <i class="bi bi-funnel me-1"></i> Category
              </label>
              <select class="form-select" id="filterCategory">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                {% for c in category_filters %}
                <option value="{{ c.name|lower }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">
                <i class="bi bi-search me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°
              </label>
              <input type="text"
                     id="searchInput"
                     class="form-control"
                     placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°">
            </div>

          </div>
        </div>
      </div>

      <!-- FLOW LIST -->
      {% regroup flow_summary by category_name as category_groups %}

      <div class="row g-4" id="flowContainer">

        {% for cat in category_groups %}
          {% regroup cat.list by team_name as team_groups %}

          <div class="col-12 col-md-6 flow-category"
               data-category="{{ cat.grouper|lower }}">

            <div class="category-box h-100">

              <div class="category-box-header">
                <i class="bi bi-file-earmark-text me-2"></i>
                {{ cat.grouper }}
              </div>

              <div class="category-box-body">

                {% for team in team_groups %}

                  <a href="{% url 'approval_flow_detail' team.list.0.category_id team.list.0.team_id %}"
                    class="team-card"
                    data-team="{{ team.grouper|lower }}">

                    <div>
                      <div class="team-name">
                        <i class="bi bi-people me-1"></i>
                        {{ team.grouper }}
                      </div>
                      <div class="team-sub">
                        {{ team.list|length }} ‡∏™‡∏≤‡∏¢‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                      </div>
                    </div>

                    <div class="team-card-right">
                      <i class="bi bi-chevron-right"></i>
                    </div>

                  </a>
                {% endfor %}

              </div>
            </div>

          </div>
        {% endfor %}

      </div>

    </div>
  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/* ===== USER AUTOCOMPLETE ===== */
const USERS = [
  {% for u in users %}
  { id: "{{ u.id }}", name: "{{ u.full_name }}" },
  {% endfor %}
];

function addRow() {
  const tbody = document.querySelector("#approveTable tbody");
  const level = tbody.rows.length + 1;

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="text-center">
      <span class="badge bg-light">${level}</span>
    </td>
    <td>
      <div class="position-relative">
        <input type="text"
               class="form-control approver-input"
               placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥..."
               autocomplete="off">
        <input type="hidden" name="approver[]" class="approver-id">
        <div class="autocomplete-box"></div>
      </div>
    </td>
    <td class="text-center">
      <button type="button"
              class="btn btn-sm btn-outline-danger"
              onclick="removeRow(this)">üóë</button>
    </td>
  `;
  tbody.appendChild(tr);
  bindAutocomplete(tr.querySelector(".approver-input"));
}

function removeRow(btn) {
  const tbody = document.querySelector("#approveTable tbody");
  if (tbody.rows.length === 1) return;
  btn.closest("tr").remove();
  [...tbody.rows].forEach((r, i) => {
    r.querySelector(".badge").textContent = i + 1;
  });
}

function bindAutocomplete(input) {
  const box = input.parentElement.querySelector(".autocomplete-box");
  const hidden = input.parentElement.querySelector(".approver-id");

  input.addEventListener("input", () => {
    const q = input.value.toLowerCase();
    box.innerHTML = "";
    hidden.value = "";

    if (!q) {
      box.style.display = "none";
      return;
    }

    USERS.filter(u => u.name.toLowerCase().includes(q))
      .forEach(u => {
        const div = document.createElement("div");
        div.className = "autocomplete-item";
        div.textContent = u.name;
        div.onclick = () => {
          input.value = u.name;
          hidden.value = u.id;
          box.style.display = "none";
        };
        box.appendChild(div);
      });

    box.style.display = "block";
  });
}

document.querySelectorAll(".approver-input").forEach(bindAutocomplete);

/* ===== FILTER & SEARCH ===== */
const filterCategory = document.getElementById("filterCategory");
const searchInput = document.getElementById("searchInput");

function applyFilter() {
  const selectedCategory = filterCategory.value.toLowerCase();
  const keyword = searchInput.value.toLowerCase();

  document.querySelectorAll(".flow-category").forEach(col => {
    const categoryName = col.dataset.category;
    const categoryMatch =
      !selectedCategory || categoryName === selectedCategory;

    let hasVisibleTeam = false;

    col.querySelectorAll(".team-card").forEach(team => {
      const teamName = team.dataset.team;

      const matchKeyword =
        !keyword || teamName.includes(keyword);

      const show = categoryMatch && matchKeyword;
      team.style.display = show ? "flex" : "none";
      if (show) hasVisibleTeam = true;
    });

    col.style.display = hasVisibleTeam ? "" : "none";
  });
}

filterCategory.addEventListener("change", applyFilter);
searchInput.addEventListener("input", applyFilter);
</script>

<!-- ================= STYLE ================= -->
<style>
.category-box {
  background: #fff;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 8px 24px rgba(0,0,0,.06);
}

.category-box-header {
  padding: 14px 18px;
  font-weight: 700;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
}

.category-box-body {
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.team-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 16px;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  background: #fff;
  transition: 0.15s;
  text-decoration: none;
  color: inherit;
}

.team-card:hover {
  background: #f1f5ff;
  border-color: #c7d2fe;
}

.team-name {
  font-weight: 600;
}

.team-sub {
  font-size: .75rem;
  color: #64748b;
}

.autocomplete-box {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 999;
}

.autocomplete-item {
  padding: 8px 12px;
  cursor: pointer;
}

.autocomplete-item:hover {
  background: #eef2ff;
}
</style>
{% endblock %}
