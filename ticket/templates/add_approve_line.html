{% extends "base.html" %}
{% block title %}ตั้งค่าสายอนุมัติ | Approval Flow{% endblock %}

{% block content %}
<main class="main-content container-fluid py-3">

<h4 class="fw-bold mb-3">ตั้งค่าสายอนุมัติ (Approval Flow)</h4>

<div class="card shadow-sm">
<div class="card-body">

<form method="post">
{% csrf_token %}

<!-- ================= Ticket Type ================= -->
<div class="mb-3">
    <label class="form-label fw-semibold">ประเภทคำขอ</label>
    <select name="ticket_type_id" class="form-select" required>
        <option value="">-- เลือกประเภทคำขอ --</option>
        {% for t in ticket_types %}
        <option value="{{ t.id }}">{{ t.name }}</option>
        {% endfor %}
    </select>
</div>

<hr>

<!-- ================= Teams Container ================= -->
<h6 class="fw-semibold mb-2">ทีมที่เกี่ยวข้องกับคำขอ</h6>

<div id="team-container"></div>

<button type="button" class="btn btn-outline-primary mb-3" onclick="addTeam()">
➕ เพิ่มทีม
</button>

<div class="mt-4 text-end">
    <button class="btn btn-primary px-4">บันทึกสายอนุมัติ</button>
</div>

</form>

</div>
</div>
</main>

<!-- ================= STYLE ================= -->
<style>
.team-card{
    border:1px solid #e0e0e0;
    border-radius:10px;
    padding:15px;
    margin-bottom:15px;
    background:#fafafa;
}
.suggest-box{
    position:absolute;
    top:100%;
    left:0;
    right:0;
    background:#fff;
    border:1px solid #ddd;
    border-radius:6px;
    max-height:240px;
    overflow-y:auto;
    z-index:2000;
    display:none;
}
.suggest-item{
    padding:10px 14px;
    cursor:pointer;
    font-size:14px;
    border-bottom:1px solid #f1f1f1;
}
.suggest-item:hover{background:#f1f3f5;}
</style>

<!-- ================= SCRIPT ================= -->
<script>
const USERS = [
{% for u in users %}
{ id:"{{ u.id }}", name:"{{ u.full_name }}", username:"{{ u.username }}" },
{% endfor %}
];

const TEAMS = [
{% for t in teams %}
{ id:"{{ t.id }}", name:"{{ t.name }}", dept:"{{ t.dept_name }}" },
{% endfor %}
];

function addTeam(){
    const container = document.getElementById("team-container");

    const teamCard = document.createElement("div");
    teamCard.className = "team-card";

    teamCard.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="fw-bold mb-0">ทีมอนุมัติ</h6>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.team-card').remove()">ลบทีม</button>
        </div>

        <div class="mb-2">
            <select name="team_ids[]" class="form-select" required>
                <option value="">-- เลือกทีม --</option>
                ${TEAMS.map(t=>`<option value="${t.id}">${t.name} (${t.dept})</option>`).join("")}
            </select>
        </div>

        <div class="approver-list"></div>

        <button type="button" class="btn btn-sm btn-success" onclick="addLevel(this)">
            ➕ เพิ่ม Level
        </button>
    `;

    container.appendChild(teamCard);
    addLevel(teamCard.querySelector("button"));
}

function addLevel(btn){
    const teamCard = btn.closest(".team-card");
    const list = teamCard.querySelector(".approver-list");
    const count = list.children.length + 1;

    if(count > 5){
        alert("สูงสุด 5 Level");
        return;
    }

    const row = document.createElement("div");
    row.className = "row g-2 mb-2 position-relative";

    row.innerHTML = `
        <div class="col-md-1 d-flex align-items-center fw-bold">L${count}</div>

        <div class="col-md-9 position-relative">
            <input type="text"
                   class="form-control user-search"
                   placeholder="พิมพ์ชื่อผู้อนุมัติ..."
                   oninput="showSuggestions(this)"
                   autocomplete="off">

            <select name="user_ids[${Date.now()}][]" class="d-none user-select" required>
                <option value="">-- เลือกผู้อนุมัติ --</option>
                ${USERS.map(u=>`<option value="${u.id}">${u.name} (${u.username})</option>`).join("")}
            </select>

            <div class="suggest-box shadow-sm"></div>
        </div>

        <div class="col-md-2">
            <button type="button" class="btn btn-danger w-100" onclick="this.closest('.row').remove()">ลบ</button>
        </div>
    `;

    list.appendChild(row);
}

function showSuggestions(input){
    const keyword = input.value.toLowerCase().trim();
    const row = input.closest(".row");
    const box = row.querySelector(".suggest-box");
    const hiddenSelect = row.querySelector(".user-select");

    box.innerHTML = "";

    if(!keyword){
        box.style.display = "none";
        hiddenSelect.value = "";
        return;
    }

    const matches = USERS.filter(u =>
        u.name.toLowerCase().includes(keyword) ||
        u.username.toLowerCase().includes(keyword)
    );

    if(matches.length === 0){
        box.style.display = "none";
        return;
    }

    matches.forEach(u=>{
        const div = document.createElement("div");
        div.className = "suggest-item";
        div.innerHTML = `<b>${u.name}</b> <span class="text-muted">(${u.username})</span>`;
        div.onclick = ()=>{
            input.value = `${u.name} (${u.username})`;
            hiddenSelect.value = u.id;
            box.style.display = "none";
        };
        box.appendChild(div);
    });

    box.style.display = "block";
}

document.addEventListener("click", function(e){
    if(!e.target.closest(".row")){
        document.querySelectorAll(".suggest-box").forEach(b=>b.style.display="none");
    }
});
</script>

{% endblock %}
