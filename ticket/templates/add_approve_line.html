{% extends "base.html" %}
{% block title %}ตั้งค่าสายอนุมัติ | Approval Flow{% endblock %}

{% block content %}
<main class="main-content container-fluid py-3">

<h4 class="fw-bold mb-3">ตั้งค่าสายอนุมัติ (Approval Flow)</h4>

<div class="card shadow-sm">
<div class="card-body">

<form method="post">
{% csrf_token %}

<!-- ================= Ticket Type ================= -->
<div class="mb-3">
    <label class="form-label fw-semibold">ประเภทคำขอ</label>
    <select name="ticket_type_id" id="ticketType" class="form-select" required onchange="renderFlow()">
        <option value="">-- เลือกประเภทคำขอ --</option>
        {% for t in ticket_types %}
        <option value="{{ t.id }}" data-category="{{ t.category }}">{{ t.name }}</option>
        {% endfor %}
    </select>
</div>

<!-- ================= Team ================= -->
<div class="mb-3">
    <label class="form-label fw-semibold">ทีมที่เกี่ยวข้อง</label>
    <select name="team_id" class="form-select" required>
        <option value="">-- เลือกทีม --</option>
        {% for t in teams %}
        <option value="{{ t.id }}">{{ t.name }} ({{ t.dept_name }})</option>
        {% endfor %}
    </select>
</div>

<hr>

<!-- ================= Approval Flow ================= -->
<h6 class="fw-bold mb-2">สายอนุมัติ</h6>
<div id="flow-container"></div>

<div class="mt-4 text-end">
    <button class="btn btn-primary px-4">บันทึกสายอนุมัติ</button>
</div>

</form>

</div>
</div>
</main>

<!-- ================= STYLE ================= -->
<style>
.flow-box{
    border:1px solid #e0e0e0;
    border-radius:10px;
    padding:15px;
    margin-bottom:12px;
    background:#fafafa;
}
.flow-title{
    font-weight:600;
    margin-bottom:6px;
}
</style>

<!-- ================= SCRIPT ================= -->
<script>
/* ===== USERS ===== */
const USERS = [
{% for u in users %}
{ id:"{{u.id}}", name:"{{u.full_name}}", username:"{{u.username}}", role:"{{u.role}}" },
{% endfor %}
];

/* ===== CATEGORY FLOW MAP ===== */
const CATEGORY_FLOW = {
  1: ["USER","HEAD","ACCOUNT","CEO","CFO","IT"],        // ERP
  2: ["USER","HEAD","IT"],                             // VPN
  3: ["USER","HEAD","IT"],                             // Building
  4: ["USER","HEAD","ACCOUNT","CEO","CFO","IT"],       // Finance
  5: ["USER","HEAD","ACCOUNT","STAKEHOLDER","IT"],     // Application
  6: ["USER","HEAD","ACCOUNT","CEO","CFO","IT"],       // Promotion
};

/* ===== Render Flow ===== */
function renderFlow(){
    const select = document.getElementById("ticketType");
    const category = select.options[select.selectedIndex].dataset.category;
    const container = document.getElementById("flow-container");

    container.innerHTML = "";

    if(!CATEGORY_FLOW[category]) return;

    CATEGORY_FLOW[category].forEach((role, idx)=>{
        const div = document.createElement("div");
        div.className = "flow-box";

        div.innerHTML = `
            <div class="flow-title">Level ${idx+1} : ${role}</div>
            <select name="flow_users[]" class="form-select" required>
                <option value="">-- เลือกผู้อนุมัติ --</option>
                ${
                    USERS.filter(u=>filterRole(u,role))
                         .map(u=>`<option value="${u.id}">${u.name} (${u.username})</option>`)
                         .join("")
                }
            </select>
        `;
        container.appendChild(div);
    });
}

/* ===== Role Filter ===== */
function filterRole(user, role){
    if(role === "USER") return true;
    if(role === "HEAD") return user.role === "manager";
    if(role === "ACCOUNT") return user.role === "account";
    if(role === "CEO") return user.role === "ceo";
    if(role === "CFO") return user.role === "cfo";
    if(role === "IT") return user.role === "it";
    if(role === "SECURITY") return user.role === "security";
    if(role === "STAKEHOLDER") return true;
    return true;
}
</script>

{% endblock %}
