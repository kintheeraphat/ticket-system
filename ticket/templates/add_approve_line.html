{% extends "base.html" %}
{% block title %}ตั้งค่าสายอนุมัติ | Approval Flow{% endblock %}

{% block content %}
<main class="main-content container-fluid py-3">

    <h4 class="fw-bold mb-3">ตั้งค่าสายอนุมัติ (Approval Flow)</h4>

    <div class="card shadow-sm">
        <div class="card-body">

            <form method="post">
                {% csrf_token %}

                <!-- ================= Ticket Type ================= -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">ประเภทคำขอ</label>
                    <select name="ticket_type_id" class="form-select" required>
                        <option value="">-- เลือกประเภทคำขอ --</option>
                        {% for t in ticket_types %}
                        <option value="{{ t.id }}">{{ t.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ================= Team ================= -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">ทีมอนุมัติ</label>
                    <select name="team_id" class="form-select" required>
                        <option value="">-- เลือกทีม --</option>
                        {% for t in teams %}
                        <option value="{{ t.id }}">
                            {{ t.name }} ({{ t.dept_name }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <hr>

                <!-- ================= Levels ================= -->
                <h6 class="fw-semibold mb-3">ลำดับผู้อนุมัติ (Level 1 → 5)</h6>

                <div id="approver-list">

                    <!-- ===== Level 1 ===== -->
                    <div class="row g-2 mb-2 approver-row">
                        <div class="col-md-10 position-relative">

                            <input type="text"
                                   class="form-control user-search"
                                   placeholder="พิมพ์ชื่อ user..."
                                   oninput="showSuggestions(this)"
                                   autocomplete="off">

                            <!-- hidden select -->
                            <select name="user_ids[]" class="d-none user-select" required>
                                <option value="">-- เลือกผู้อนุมัติ --</option>
                                {% for u in users %}
                                <option value="{{ u.id }}">{{ u.full_name }} ({{ u.username }})</option>
                                {% endfor %}
                            </select>

                            <div class="suggest-box shadow-sm"></div>

                        </div>

                        <div class="col-md-2">
                            <button type="button"
                                    class="btn btn-success w-100"
                                    onclick="addRow()">+</button>
                        </div>
                    </div>

                </div>

                <div class="mt-4 text-end">
                    <button class="btn btn-primary px-4">
                        บันทึกสายอนุมัติ
                    </button>
                </div>

            </form>

        </div>
    </div>

</main>

<!-- ================= STYLE ================= -->
<style>
.suggest-box{
    position:absolute;
    top:100%;
    left:0;
    right:0;
    background:#fff;
    border:1px solid #ddd;
    border-radius:6px;
    max-height:240px;
    overflow-y:auto;
    z-index:2000;
    display:none;
}

.suggest-item{
    padding:10px 14px;
    cursor:pointer;
    font-size:14px;
    border-bottom:1px solid #f1f1f1;
}
.suggest-item:last-child{border-bottom:none;}
.suggest-item:hover{background:#f1f3f5;}
</style>

<!-- ================= SCRIPT ================= -->
<script>
const USERS = [
    {% for u in users %}
    {
        id: "{{ u.id }}",
        name: "{{ u.full_name }}",
        username: "{{ u.username }}"
    },
    {% endfor %}
];

function addRow(){
    const container = document.getElementById("approver-list");
    const count = container.children.length + 1;

    if(count > 5){
        alert("สูงสุด 5 Level เท่านั้น");
        return;
    }

    const row = document.createElement("div");
    row.className = "row g-2 mb-2 approver-row";
    row.innerHTML = `
        <div class="col-md-10 position-relative">
            <input type="text"
                   class="form-control user-search"
                   placeholder="พิมพ์ชื่อ user..."
                   oninput="showSuggestions(this)"
                   autocomplete="off">

            <select name="user_ids[]" class="d-none user-select" required>
                <option value="">-- เลือกผู้อนุมัติ --</option>
                ${USERS.map(u=>`<option value="${u.id}">${u.name} (${u.username})</option>`).join("")}
            </select>

            <div class="suggest-box shadow-sm"></div>
        </div>

        <div class="col-md-2">
            <button type="button"
                    class="btn btn-danger w-100"
                    onclick="this.closest('.approver-row').remove()">ลบ</button>
        </div>
    `;
    container.appendChild(row);
}

function showSuggestions(input){
    const keyword = input.value.toLowerCase().trim();
    const row = input.closest(".approver-row");
    const box = row.querySelector(".suggest-box");
    const hiddenSelect = row.querySelector(".user-select");

    box.innerHTML = "";

    if(keyword.length === 0){
        box.style.display = "none";
        hiddenSelect.value = "";
        return;
    }

    const matches = USERS.filter(u =>
        u.name.toLowerCase().includes(keyword) ||
        u.username.toLowerCase().includes(keyword)
    );

    if(matches.length === 0){
        box.style.display = "none";
        return;
    }

    matches.forEach(u=>{
        const div = document.createElement("div");
        div.className = "suggest-item";
        div.innerHTML = `<b>${u.name}</b> <span class="text-muted">(${u.username})</span>`;
        div.onclick = ()=>{
            input.value = `${u.name} (${u.username})`;
            hiddenSelect.value = u.id;
            box.style.display = "none";
        };
        box.appendChild(div);
    });

    box.style.display = "block";
}

document.addEventListener("click", function(e){
    if(!e.target.closest(".approver-row")){
        document.querySelectorAll(".suggest-box").forEach(b=>{
            b.style.display = "none";
        });
    }
});
</script>

{% endblock %}
