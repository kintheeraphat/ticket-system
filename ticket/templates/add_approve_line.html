{% extends "base.html" %}
{% load static %}

{% block title %}Add Approve Line{% endblock %}

{% block content %}

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">ตั้งค่าสายอนุมัติ (Approval Flow)</h5>
        </div>

        <div class="card-body">

            <!-- ===== messages ===== -->
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
            {% endif %}

            <form method="post">
                {% csrf_token %}

                <!-- ================= CATEGORY ================= -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Category</label>
                    <select name="category_id" id="categorySelect" class="form-select" required>
                        <option value="">-- เลือก Category --</option>
                        {% for c in categories %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ================= TEAM ================= -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Team</label>
                    <select name="team_id" class="form-select" required>
                        <option value="">-- เลือก Team --</option>
                        {% for t in teams %}
                        <option value="{{ t.id }}">
                            {{ t.dept_name }} - {{ t.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <hr>

                <!-- ================= APPROVE LEVELS ================= -->
                <div id="approveLevels" style="display:none;">

                    <!-- Level 1 -->
                    <div class="mb-3 level-box" data-level="1">
                        <label class="form-label fw-bold">Level 1 : หัวหน้า</label>
                        <select name="user_ids[]" class="form-select level-input">
                            <option value="">-- เลือกหัวหน้า --</option>
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.full_name }} ({{ u.username }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Level 2 -->
                    <div class="mb-3 level-box" data-level="2">
                        <label class="form-label fw-bold">Level 2 : บัญชี</label>
                        <select name="user_ids[]" class="form-select level-input">
                            <option value="">-- เลือกบัญชี --</option>
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.full_name }} ({{ u.username }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Level 3 -->
                    <div class="mb-3 level-box" data-level="3">
                        <label class="form-label fw-bold">
                            Level 3 : CEO / CFO 
                            <span class="text-muted small">(ไม่จำเป็น)</span>
                        </label>
                        <select name="user_ids[]" class="form-select level-input">
                            <option value="">-- ข้ามได้ --</option>
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.full_name }} ({{ u.username }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Level 4 -->
                    <div class="mb-3 level-box" data-level="4">
                        <label class="form-label fw-bold">Level 4 : IT / Admin</label>
                        <select name="user_ids[]" class="form-select level-input">
                            <option value="">-- เลือก IT / Admin --</option>
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.full_name }} ({{ u.username }})</option>
                            {% endfor %}
                        </select>
                    </div>

                </div>

                <hr>

                <div class="text-end">
                    <button type="submit" class="btn btn-primary px-4">
                        บันทึกสายอนุมัติ
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
    const categorySelect = document.getElementById("categorySelect");
    const approveLevels = document.getElementById("approveLevels");
    const levelBoxes = document.querySelectorAll(".level-box");

    // category rule map
    const CATEGORY_RULES = {
        "1": { levels: 4, optional: [] },     // ERP
        "4": { levels: 4, optional: [] },     // Adjust
        "5": { levels: 4, optional: [3] },    // Application
        "2": { levels: 4, optional: [3] },    // VPN
        "6": { levels: 3, optional: [] },     // Active Promotion
        "3": { levels: 2, optional: [] },     // Building
    };

    categorySelect.addEventListener("change", function () {
        const val = this.value;

        if (!CATEGORY_RULES[val]) {
            approveLevels.style.display = "none";
            return;
        }

        const rule = CATEGORY_RULES[val];
        const maxLevels = rule.levels;

        approveLevels.style.display = "block";

        levelBoxes.forEach(box => {
            const lvl = parseInt(box.dataset.level);
            const select = box.querySelector("select");

            if (lvl <= maxLevels) {
                box.style.display = "block";
            } else {
                box.style.display = "none";
                select.value = ""; // clear hidden
            }

            // optional handling
            if (rule.optional.includes(lvl)) {
                select.required = false;
            } else {
                select.required = true;
            }
        });
    });
</script>

{% endblock %}
