{% extends "base.html" %}
{% load static %}

{% block title %}‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå{% endblock %}

{% block content %}
<div class="dashboard-table shadow-sm p-4 bg-white rounded">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h4 class="fw-bold text-primary mb-1">
                <i class="fas fa-box-open me-2"></i>‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            </h4>
            <p class="text-muted small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
        </div>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show rounded-3" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}

        {% csrf_token %}

        <!-- DATE -->
        <div class="mb-4 p-3 bg-light rounded border">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="fw-bold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏≥</label>
                    <div class="form-control bg-white">
                        {{ "09/01/2026" }}
                        <!-- {{ today|date:"d/m/Y" }} -->
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="fw-bold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</label>
                    <input type="date" name="borrow_date[]" value="{{ today|date:'Y-m-d' }}" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="fw-bold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</label>
                    <input type="date" name="return_date[]" class="form-control" required>
                </div>
            </div>
        </div>

        <!-- USER INFO -->
        <!-- <div class="mb-4">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="fw-bold">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                    <div class="form-control bg-light">Lamina Films</div>
                </div>
                <div class="col-md-6">
                    <label class="fw-bold">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                    <div class="form-control bg-light">{{ user.department }}</div>
                </div>
                <div class="col-md-6">
                    <label class="fw-bold">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
                    <div class="form-control bg-light">{{ user.fname }} {{ user.lname }}</div>
                </div>
            </div>
        </div> -->

        <hr class="my-4">

        <!-- EQUIPMENT TABLE -->
        <div class="mb-3">
            <label class="fw-bold mb-2">
                <i class="fas fa-list me-1"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            </label>

            <div class="table-responsive border rounded">
                <table class="table table-bordered align-middle mb-0">
                    <thead class="table-primary text-center">
                        <tr>
                            <th style="width:50px;">#</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                            <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                            <th style="width:90px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="width:50px;">‡∏•‡∏ö</th>
                        </tr>
                    </thead>
                    <tbody id="equipment-tbody">
                        <tr>
                            <td class="row-index text-center">1</td>
                            <td class="position-relative">
                                <input type="text" name="item_name[]" class="form-control item-autocomplete" required>
                                <div class="item-selected-name small text-primary mt-1"></div>
                            </td>
                            <td>
                                <input type="text" name="details[]" class="form-control">
                            </td>
                            <td>
                                <input type="number" name="quantity[]" value="1" min="1" class="form-control">
                            </td>
                            <td class="text-center">
                                <button type="button" onclick="deleteRow(this)"
                                    class="btn btn-sm btn-outline-danger">√ó</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <button type="button" id="add-row-btn" class="btn btn-outline-secondary btn-sm mt-2">
                <i class="fas fa-plus me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </button>
        </div>

        <hr class="my-4">

        <!-- FILE -->
        <div class="mb-4">
            <label class="fw-bold mb-2">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <input type="file" name="order_file[]" multiple class="form-control">
        </div>
        <hr class="my-4">
        <div class="mb-4">
            <label class="fw-bold mb-2">
                <i class="fas fa-exclamation-circle me-1 text-danger"></i>
                ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô
            </label>

            <select name="priority" class="form-select" required>
                <option value="normal">üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥</option>
                <option value="urgent">üü° ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</option>
                <option value="critical">üî¥ ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å (‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏á‡∏≤‡∏ô)</option>
            </select>

            <small class="text-muted">
                ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
            </small>
        </div>
        <!-- ACTION -->
        <div class="text-end border-top pt-3">
            <button type="reset" class="btn btn-light me-2 border">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button type="submit" class="btn btn-primary px-5 fw-bold shadow-sm">
                <i class="fas fa-paper-plane me-2"></i>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠
            </button>
        </div>
    </form>
</div>

{{ items|json_script:"items-data" }}
{% endblock %}

{% block extra_js %}
<script>
const tbody = document.getElementById("equipment-tbody");
const addBtn = document.getElementById("add-row-btn");
const itemsList = JSON.parse(document.getElementById("items-data").textContent);

function updateRowIndices(){
    tbody.querySelectorAll(".row-index").forEach((c,i)=>c.textContent=i+1);
}

function deleteRow(btn){
    if(tbody.rows.length===1){
        alert("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
        return;
    }
    btn.closest("tr").remove();
    updateRowIndices();
}

function createNewRow(){
    const tr=document.createElement("tr");
    tr.innerHTML=`
        <td class="row-index text-center"></td>
        <td class="position-relative">
            <input type="text" name="item_name[]" class="form-control item-autocomplete" required>
            <div class="item-selected-name small text-primary mt-1"></div>
        </td>
        <td><input type="text" name="details[]" class="form-control"></td>
        <td><input type="number" name="quantity[]" value="1" min="1" class="form-control"></td>
        <td class="text-center">
            <button type="button" onclick="deleteRow(this)" class="btn btn-sm btn-outline-danger">√ó</button>
        </td>`;
    tbody.appendChild(tr);
    setupAutocomplete(tr.querySelector(".item-autocomplete"));
    updateRowIndices();
}

function setupAutocomplete(input){
    const selected=input.parentNode.querySelector(".item-selected-name");
    input.addEventListener("input",()=>{
        document.querySelectorAll(".autocomplete-items").forEach(e=>e.remove());
        const val=input.value.toLowerCase();
        if(!val) return;
        const list=document.createElement("div");
        list.className="autocomplete-items list-group position-absolute w-100 shadow";
        list.style.zIndex=1000;
        input.parentNode.appendChild(list);
        itemsList.forEach(item=>{
            if(item.thainame.toLowerCase().includes(val)){
                const d=document.createElement("button");
                d.type="button";
                d.className="list-group-item list-group-item-action";
                d.textContent=item.thainame;
                d.onclick=()=>{
                    input.value=item.thainame;
                    selected.textContent="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: "+item.thainame;
                    list.remove();
                };
                list.appendChild(d);
            }
        });
    });
}

setupAutocomplete(document.querySelector(".item-autocomplete"));
addBtn.addEventListener("click",createNewRow);
updateRowIndices();
</script>
{% endblock %}
