{% extends "base.html" %}
{% load tz %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô{% endblock %}

{% block content %}
<main class="main-content">

    <div class="dashboard-card">

        <h3 class="fw-bold mb-3">
            {{ ticket.title }}
        </h3>

        <p class="text-muted mb-4">
            ‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏î‡∏¢ {{ ticket.user_name }}
            {% if ticket.department %}
            | ‡πÅ‡∏ú‡∏ô‡∏Å {{ ticket.department }}
            {% endif %}
            <br>
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {{ ticket.create_at|localtime|date:"d M Y H:i" }} ‡∏ô.
        </p>

        <hr>

        <!-- DESCRIPTION -->
        <div class="mb-4">
            <h6 class="fw-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠</h6>
            <p>{{ ticket.description|linebreaksbr }}</p>
        </div>

        <!-- OLD / NEW VALUE -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header fw-semibold">
                        ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° (Old Value)
                    </div>
                    <div class="card-body">
                        <pre class="mb-0">{{ detail.old_value }}</pre>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header fw-semibold">
                        ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà (New Value)
                    </div>
                    <div class="card-body">
                        <pre class="mb-0">{{ detail.new_value }}</pre>
                    </div>
                </div>
            </div>
        </div>

        {# ================= APPROVE SECTION ================= #}
        {% if can_approve or is_admin %}
        <div class="card shadow-sm border-success mb-4">
            <div class="card-body">

                {# ---------- INFO ---------- #}
                {% if is_admin %}
                <div class="fw-semibold text-danger mb-2">
                    ‚ö† ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin
                </div>
                {% else %}
                <div class="fw-semibold text-success mb-2">
                    ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ (Level {{ my_level }})
                </div>
                {% endif %}

                {# ---------- APPROVE ‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏¢ ---------- #}
                {% if can_approve %}
                <form method="post" action="{% url 'approve_ticket' ticket.id %}" class="mb-2">
                    {% csrf_token %}
                    <textarea name="remark" class="form-control mb-2" rows="2"
                        placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
                    <button type="submit" class="btn btn-success">
                        ‚úÖ Approve
                    </button>
                </form>
                {% endif %}

                {# ---------- ADMIN ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô ---------- #}
                {% if is_admin and ticket.status_id != 4 and ticket.status_id != 5 %}
                <form method="post" action="{% url 'approve_ticket' ticket.id %}" class="mb-2">
                    {% csrf_token %}
                    <input type="hidden" name="admin_override" value="1">
                    <button type="submit" class="btn btn-danger">
                        üöÄ Admin ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
                    </button>
                </form>
                {% endif %}

                {# ---------- ADMIN ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏á‡∏≤‡∏ô ---------- #}
                {% if is_admin and ticket.status_id == 8 %}
                <div class="card shadow-sm border-primary mb-4">
                    <div class="card-body text-center">

                        <div class="fw-semibold text-primary mb-2">
                            üõ† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô
                        </div>

                        <form method="post" action="{% url 'admin_complete_ticket' ticket.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary btn-lg">
                                ‚úÖ ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
                            </button>
                        </form>

                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {%endblock %}