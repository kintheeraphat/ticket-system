{% extends "base.html" %}
{% block title %}‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ | Team Setup{% endblock %}

{% block content %}
<main class="container-fluid">

  <h2 class="fw-bold mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>

  <div class="row g-4">

    <!-- ================= CREATE TEAM ================= -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">

          <h5 class="fw-semibold mb-3">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà</h5>

          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="create">

            <div class="mb-3">
              <label class="form-label">‡πÅ‡∏ú‡∏ô‡∏Å</label>
              <select name="department_id" class="form-select" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                {% for d in departments %}
                <option value="{{ d.id }}">{{ d.dept_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</label>
              <input name="team_name" class="form-control" required>
            </div>

            <button class="btn btn-primary w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </form>

        </div>
      </div>
    </div>

    <!-- ================= TEAM LIST ================= -->
    <div class="col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-body">

          <!-- Search + Filter -->
          <div class="row g-2 mb-3">
            <div class="col-md-7">
              <input id="searchName"
                     class="form-control"
                     placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°">
            </div>
            <div class="col-md-5">
              <select id="filterDept" class="form-select">
                <option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                {% for d in departments %}
                  <option value="{{ d.id }}">{{ d.dept_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="list-group team-scroll">

            {% if teams %}
              {% for t in teams %}
              <div class="list-group-item team-item"
                   data-name="{{ t.team_name|lower }}"
                   data-dept-id="{{ t.department_id }}">

                <!-- ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏° -->
                <a href="{% url 'team_adduser' t.id %}"
                   class="text-decoration-none text-dark d-block">

                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold">{{ t.team_name }}</div>
                      <small class="text-muted">{{ t.dept_name }}</small>
                    </div>
                    <span class="badge bg-primary rounded-pill">
                      üë• {{ t.member_count }}
                    </span>
                  </div>
                </a>

                <!-- Action -->
                <div class="mt-2 text-end">

                  <button class="btn btn-sm btn-outline-warning"
                          data-bs-toggle="modal"
                          data-bs-target="#editModal"
                          data-id="{{ t.id }}"
                          data-name="{{ t.team_name }}"
                          data-dept="{{ t.department_id }}"
                          onclick="event.stopPropagation()">
                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                  </button>

                  <form method="post"
                        class="d-inline"
                        onclick="event.stopPropagation()"
                        onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏µ‡∏°?')">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="team_id" value="{{ t.id }}">

                    {% if t.member_count > 0 %}
                      <button class="btn btn-sm btn-outline-danger"
                              disabled
                              title="‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô">
                        ‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                      </button>
                    {% else %}
                      <button class="btn btn-sm btn-outline-danger">
                        ‡∏•‡∏ö
                      </button>
                    {% endif %}
                  </form>

                </div>

              </div>
              {% endfor %}
            {% else %}
              <!-- Empty State -->
              <div class="text-center text-muted py-5">
                <h6>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h6>
                <small>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢</small>
              </div>
            {% endif %}

          </div>

        </div>
      </div>
    </div>

  </div>
</main>

<!-- ================= EDIT MODAL ================= -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update">
        <input type="hidden" name="team_id" id="edit_id">

        <div class="modal-header">
          <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡∏°</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</label>
          <input id="edit_name"
                 name="team_name"
                 class="form-control mb-3">

          <label class="form-label">‡πÅ‡∏ú‡∏ô‡∏Å</label>
          <select id="edit_dept"
                  name="department_id"
                  class="form-select">
            {% for d in departments %}
            <option value="{{ d.id }}">{{ d.dept_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button class="btn btn-primary">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<style>
.team-scroll {
  max-height: 520px;
  overflow-y: auto;
}
.team-item {
  border-radius: 10px;
  margin-bottom: 8px;
  transition: 0.15s;
}
.team-item:hover {
  background: #f8fafc;
}
</style>

<script>
/* ===== Edit Modal ===== */
document.getElementById("editModal")
  .addEventListener("show.bs.modal", e => {
    const b = e.relatedTarget;
    edit_id.value = b.dataset.id;
    edit_name.value = b.dataset.name;
    edit_dept.value = b.dataset.dept;
  });

/* ===== Filter Team ===== */
const searchName = document.getElementById("searchName");
const filterDept = document.getElementById("filterDept");
const items = document.querySelectorAll(".team-item");

function filterTeams() {
  const nameQ = searchName.value.toLowerCase();
  const deptQ = filterDept.value;

  items.forEach(item => {
    const matchName = item.dataset.name.includes(nameQ);
    const matchDept = !deptQ || item.dataset.deptId === deptQ;
    item.style.display = (matchName && matchDept) ? "" : "none";
  });
}

searchName.addEventListener("keyup", filterTeams);
filterDept.addEventListener("change", filterTeams);
</script>
{% endblock %}
