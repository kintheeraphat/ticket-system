{% extends "base.html" %}
{% block title %}‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ | Team Setup{% endblock %}

{% block content %}
<main class="main-content container-fluid">

  <!-- HEADER -->
  <div class="mb-4">
    <h2 class="fw-bold mb-1">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
    <p class="text-muted">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Workflow</p>
  </div>

  <div class="row g-4">

    <!-- ================= CREATE TEAM ================= -->
    <div class="col-xl-4 col-lg-5">
      <div class="card shadow-sm border-0">
        <div class="card-body">

          <h5 class="fw-semibold mb-3">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà</h5>

          <form method="post">
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label fw-semibold">‡πÅ‡∏ú‡∏ô‡∏Å</label>
              <select name="department_id" class="form-select" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
                {% for d in departments %}
                <option value="{{ d.id }}">{{ d.dept_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
              <input type="text"
                     name="team_name"
                     class="form-control"
                     placeholder="‡πÄ‡∏ä‡πà‡∏ô IT Manager Approval"
                     required>
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 1</label>
              <select name="approver_lv1" class="form-select" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                {% for u in users %}
                <option value="{{ u.id }}">{{ u.full_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-4">
              <label class="form-label fw-semibold">
                ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 2 <span class="text-muted">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span>
              </label>
              <select name="approver_lv2" class="form-select">
                <option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                {% for u in users %}
                <option value="{{ u.id }}">{{ u.full_name }}</option>
                {% endfor %}
              </select>
            </div>

            <button class="btn btn-primary w-100">
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            </button>
          </form>

        </div>
      </div>
    </div>

    <!-- ================= TEAM LIST ================= -->
    <div class="col-xl-8 col-lg-7">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">

          <h5 class="fw-semibold mb-3">‡∏ó‡∏µ‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h5>

          <!-- Search & Filter -->
          <div class="row g-2 mb-3">
            <div class="col-md-7">
              <input type="text"
                     id="teamSearch"
                     class="form-control"
                     placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°">
            </div>
            <div class="col-md-5">
              <select id="deptFilter" class="form-select">
                <option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                {% for d in departments %}
                <option value="{{ d.dept_name }}">{{ d.dept_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- LIST -->
          <div class="list-group team-scroll">
            {% for t in teams %}
            <a href="{% url 'team_adduser' t.id %}"
               class="list-group-item list-group-item-action team-item"
               data-team="{{ t.team_name|lower }}"
               data-dept="{{ t.dept_name }}">

              <div class="d-flex justify-content-between">
                <div>
                  <div class="fw-semibold">{{ t.team_name }}</div>
                  <div class="text-muted small">
                    {{ t.dept_name }} ¬∑ üë• {{ t.member_count }} ‡∏Ñ‡∏ô
                  </div>
                </div>

                <div class="text-end small">
                  {% if t.approver_lv1 %}
                  <div>Lv1: {{ t.approver_lv1 }}</div>
                  {% endif %}
                  {% if t.approver_lv2 %}
                  <div>Lv2: {{ t.approver_lv2 }}</div>
                  {% endif %}
                </div>
              </div>

            </a>
            {% empty %}
            <div class="text-muted text-center py-4">
              ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°
            </div>
            {% endfor %}
          </div>

        </div>
      </div>
    </div>

  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  const search = document.getElementById("teamSearch");
  const filter = document.getElementById("deptFilter");
  const items = document.querySelectorAll(".team-item");

  function applyFilter() {
    const keyword = search.value.toLowerCase();
    const dept = filter.value;

    items.forEach(item => {
      const name = item.dataset.team;
      const d = item.dataset.dept;
      item.style.display =
        name.includes(keyword) && (!dept || d === dept)
        ? ""
        : "none";
    });
  }

  search.addEventListener("keyup", applyFilter);
  filter.addEventListener("change", applyFilter);

});
</script>

<style>
.team-scroll {
  max-height: 520px;
  overflow-y: auto;
}
</style>
{% endblock %}
