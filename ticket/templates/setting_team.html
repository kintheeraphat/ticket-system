{% extends "base.html" %}
{% load static %}
{% block title %}‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ | Team Setup{% endblock %}

{% block content %}
<main class="container-fluid">

  <h2 class="fw-bold mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>

  <div class="row g-4">

    <!-- CREATE TEAM -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">

          <h5 class="fw-semibold mb-3">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà</h5>

          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="create">

            <div class="mb-3">
              <label class="form-label">‡πÅ‡∏ú‡∏ô‡∏Å</label>
              <select name="department_id" class="form-select" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                {% for d in departments %}
                <option value="{{ d.id }}">{{ d.dept_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</label>
              <input name="team_name" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Approver Lv1</label>
              <select name="approver_lv1" class="form-select" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                {% for u in users %}
                <option value="{{ u.id }}">{{ u.full_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Approver Lv2</label>
              <select name="approver_lv2" class="form-select">
                <option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                {% for u in users %}
                <option value="{{ u.id }}">{{ u.full_name }}</option>
                {% endfor %}
              </select>
            </div>

            <button class="btn btn-primary w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </form>

        </div>
      </div>
    </div>

    <!-- TEAM LIST -->
    <div class="col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-body">

          <div class="row g-2 mb-3">
            <div class="col">
              <input id="search" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡∏°">
            </div>
            <div class="col">
              <select id="filter" class="form-select">
                <option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                {% for d in departments %}
                <option value="{{ d.dept_name }}">{{ d.dept_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="list-group team-scroll">

          {% for t in teams %}
          <div class="list-group-item team-item"
              data-name="{{ t.team_name|lower }}"
              data-dept="{{ t.dept_name }}">

            <!-- ‚úÖ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ = ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ team_adduser -->
            <a href="{% url 'team_adduser' t.id %}"
              class="team-link d-block text-decoration-none text-dark">

              <div class="d-flex justify-content-between">
                <div>
                  <div class="fw-semibold">{{ t.team_name }}</div>
                  <small class="text-muted">
                    {{ t.dept_name }} ¬∑ üë• {{ t.member_count }} ‡∏Ñ‡∏ô
                  </small>
                </div>

                <div class="text-end small">
                  <div>Lv1: {{ t.approver_lv1_name }}</div>
                  {% if t.approver_lv2_name %}
                  <div>Lv2: {{ t.approver_lv2_name }}</div>
                  {% endif %}
                </div>
              </div>
            </a>

            <!-- ‚ùå ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏û‡∏≤‡πÑ‡∏õ adduser -->
            <div class="mt-2 text-end">

              <button class="btn btn-sm btn-outline-warning"
                      data-bs-toggle="modal"
                      data-bs-target="#editModal"
                      data-id="{{ t.id }}"
                      data-name="{{ t.team_name }}"
                      data-dept="{{ t.department_id }}"
                      data-lv1="{{ t.approver_lv1 }}"
                      data-lv2="{{ t.approver_lv2 }}"
                      onclick="event.stopPropagation()">
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
              </button>

              <form method="post"
                    class="d-inline"
                    onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏µ‡∏°?')"
                    onclick="event.stopPropagation()">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="team_id" value="{{ t.id }}">
                <button class="btn btn-sm btn-outline-danger">‡∏•‡∏ö</button>
              </form>

            </div>

          </div>
          {% endfor %}

        </div>


        </div>
      </div>
    </div>

  </div>
</main>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update">
        <input type="hidden" name="team_id" id="edit_id">

        <div class="modal-header">
          <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡∏°</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input id="edit_name" name="team_name" class="form-control mb-2">
          <select id="edit_dept" name="department_id" class="form-select mb-2">
            {% for d in departments %}
            <option value="{{ d.id }}">{{ d.dept_name }}</option>
            {% endfor %}
          </select>
          <select id="edit_lv1" name="approver_lv1" class="form-select mb-2">
            {% for u in users %}
            <option value="{{ u.id }}">{{ u.full_name }}</option>
            {% endfor %}
          </select>
          <select id="edit_lv2" name="approver_lv2" class="form-select">
            <option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
            {% for u in users %}
            <option value="{{ u.id }}">{{ u.full_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.team-scroll {
  max-height: 520px;
  overflow-y: auto;

  .team-item {
  border-radius: 10px;
  margin-bottom: 8px;
  transition: background .15s ease;
}

.team-link:hover {
  background: #f8fafc;
}
}
</style>

<script>
document.getElementById("editModal").addEventListener("show.bs.modal", e => {
  const b = e.relatedTarget;
  edit_id.value = b.dataset.id;
  edit_name.value = b.dataset.name;
  edit_dept.value = b.dataset.dept;
  edit_lv1.value = b.dataset.lv1;
  edit_lv2.value = b.dataset.lv2 || "";
});

const search = document.getElementById("search");
const filter = document.getElementById("filter");
document.querySelectorAll(".team-item").forEach(item => {
  const fn = () => {
    item.style.display =
      item.dataset.name.includes(search.value.toLowerCase()) &&
      (!filter.value || item.dataset.dept === filter.value)
      ? "" : "none";
  };
  search.addEventListener("keyup", fn);
  filter.addEventListener("change", fn);
});
</script>
{% endblock %}
