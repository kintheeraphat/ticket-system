{% extends "base.html" %}
{% load tz %}
{% block title %}รายการคำขอทั้งหมด | Ticket System{% endblock %}

{% block content %}
<main class="main-content">

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">

<style>
#ticketTable tbody tr {
    cursor: pointer;
}
#ticketTable tbody tr:hover {
    background-color: #f8f9fa;
}
</style>

<!-- ================= HEADER ================= -->
<div class="d-flex justify-content-between align-items-center mb-4 pt-2">
    <div>
        <h2 class="fw-bold text-dark mb-1">รายการคำขอทั้งหมด</h2>
        <p class="text-muted small mb-0">
            ตรวจสอบและบริหารจัดการสถานะรายการแจ้งซ่อมหรือคำร้องขอภายในระบบ
        </p>
    </div>
</div>

<!-- ================= FILTER ================= -->
<div class="dashboard-table mb-4 p-4">
<form class="row g-3 align-items-end" onsubmit="return false;">

    <!-- Status -->
    <div class="col-md-2">
        <label class="form-label small text-muted">สถานะ</label>
        <select id="statusFilter" class="form-select">
            <option value="">ทุกสถานะ</option>
            <option value="รอดำเนินการ">รอดำเนินการ</option>
            <option value="รออนุมัติ">รออนุมัติ</option>
            <option value="ดราฟ">ดราฟ</option>
            <option value="เสร็จสิ้นแล้ว">เสร็จสิ้นแล้ว</option>
        </select>
    </div>

    <!-- Assignee -->
    <div class="col-md-3">
        <label class="form-label small text-muted">ผู้รับผิดชอบ</label>
        <select id="assigneeFilter" class="form-select">
            <option value="">ทุกคน</option>
            {% for t in tickets %}
            {% if t.assignee != "ยังไม่มอบหมาย" %}
            <option value="{{ t.assignee }}">{{ t.assignee }}</option>
            {% endif %}
            {% endfor %}
        </select>
    </div>

    <!-- Quick Date Filter -->
    <div class="col-md-2">
        <label class="form-label small text-muted">ช่วงเวลา</label>
        <select id="quickDateFilter" class="form-select">
            <option value="">เดือนปัจจุบัน</option>
            <option value="7">7 วันที่แล้ว</option>
            <option value="14">14 วันที่แล้ว</option>
            <option value="last_month">เดือนที่แล้ว</option>
        </select>
    </div>

    <!-- Custom Date -->
    <div class="col-md-2">
        <label class="form-label small text-muted">จากวันที่</label>
        <input type="date" id="startDate" class="form-control">
    </div>

    <div class="col-md-2">
        <label class="form-label small text-muted">ถึงวันที่</label>
        <input type="date" id="endDate" class="form-control">
    </div>

    <!-- Clear -->
    <div class="col-md-1">
        <button id="clearFilters" class="btn btn-outline-secondary w-100">
            ล้าง
        </button>
    </div>

</form>
</div>

<!-- ================= TABLE ================= -->
<div class="dashboard-table overflow-hidden">
<div class="table-responsive">
<table id="ticketTable" class="table table-hover align-middle mb-0">

<thead>
<tr>
    <th class="text-center">รหัส</th>
    <th>ผู้แจ้ง</th>
    <th>หมวดหมู่</th>
    <th>รายละเอียดคำขอ</th>
    <th>วันที่</th>
    <th class="text-center">สถานะ</th>
    <th>ผู้รับผิดชอบ</th>
    <th></th>
</tr>
</thead>

<tbody>
{% for t in tickets %}
<tr data-href="{% url 'tickets_detail' %}?id={{ t.id }}">

    <td class="text-center">#{{ t.id }}</td>
    <td>{{ t.requester }}</td>
    <td>{{ t.ticket_type }}</td>

    <td>
        <div class="fw-bold">{{ t.title }}</div>
        <small class="text-muted">{{ t.description }}</small>
    </td>

    <!-- ✅ เวลาไทย + ใช้เวลาไทยกับ filter -->
    <td data-date="{{ t.created_at|localtime|date:'Y-m-d H:i:s' }}">
        <div>{{ t.created_at|localtime|date:"d M Y" }}</div>
        <small class="text-muted">
            {{ t.created_at|localtime|date:"H:i" }} น.
        </small>
    </td>

    <td class="text-center">{{ t.status }}</td>
    <td>{{ t.assignee }}</td>

    <td class="text-end">
        <a href="{% url 'tickets_detail' %}?id={{ t.id }}"
           class="btn btn-outline-secondary btn-sm rounded-circle">
            <i class="fas fa-chevron-right"></i>
        </a>
    </td>

</tr>
{% endfor %}
</tbody>

</table>
</div>
</div>

<!-- ================= JS ================= -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
$(function () {

    const today = new Date();

    // ===== Date Filter (ใช้เวลาไทยจาก data-date) =====
    $.fn.dataTable.ext.search.push(function (settings, data, index) {

        const row = $('#ticketTable tbody tr').eq(index);
        const dateStr = row.find('[data-date]').data('date');
        if (!dateStr) return true;

        const rowDate = new Date(dateStr);

        const quick = $('#quickDateFilter').val();
        const startVal = $('#startDate').val();
        const endVal = $('#endDate').val();

        // Custom date
        if (startVal || endVal) {
            const start = startVal ? new Date(startVal) : null;
            const end = endVal ? new Date(endVal) : null;

            if (start && rowDate < start) return false;
            if (end && rowDate > end) return false;
            return true;
        }

        // Quick filter: 7 / 14 days
        if (quick === "7" || quick === "14") {
            const days = parseInt(quick);
            const from = new Date();
            from.setDate(today.getDate() - days);
            return rowDate >= from && rowDate <= today;
        }

        // Quick filter: last month
        if (quick === "last_month") {
            const first = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const last = new Date(today.getFullYear(), today.getMonth(), 0);
            return rowDate >= first && rowDate <= last;
        }

        // Default: current month
        return rowDate.getMonth() === today.getMonth() &&
               rowDate.getFullYear() === today.getFullYear();
    });

    const table = $('#ticketTable').DataTable({
        pageLength: 10,
        order: [[4, 'desc']],
        language: {
            zeroRecords: "ไม่พบข้อมูล"
        }
    });

    // Click row → detail
    $('#ticketTable tbody').on('click', 'tr', function (e) {
        if ($(e.target).closest('a,button').length) return;
        window.location = $(this).data('href');
    });

    // Filters
    $('#statusFilter').on('change', () =>
        table.column(5).search($('#statusFilter').val()).draw()
    );

    $('#assigneeFilter').on('change', () =>
        table.column(6).search($('#assigneeFilter').val()).draw()
    );

    $('#quickDateFilter').on('change', function () {
        $('#startDate,#endDate').val('');
        table.draw();
    });

    $('#startDate,#endDate').on('change', function () {
        $('#quickDateFilter').val('');
        table.draw();
    });

    $('#clearFilters').on('click', function () {
        $('#statusFilter,#assigneeFilter,#quickDateFilter,#startDate,#endDate').val('');
        table.search('').columns().search('');
        table.draw();
    });

    table.draw();
});
</script>

</main>
{% endblock %}
