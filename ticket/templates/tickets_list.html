{% extends "base.html" %}
{% block title %}รายการคำขอทั้งหมด | Ticket System{% endblock %}

{% block content %}
<main class="main-content">

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<!-- ================= HEADER ================= -->
<div class="d-flex justify-content-between align-items-center mb-4 pt-2">
    <div>
        <h2 class="fw-bold text-dark mb-1">รายการคำขอทั้งหมด</h2>
        <p class="text-muted small mb-0">
            ตรวจสอบและบริหารจัดการสถานะรายการแจ้งซ่อมหรือคำร้องขอภายในระบบ
        </p>
    </div>
</div>

<!-- ================= FILTER ================= -->
<div class="dashboard-table mb-4 p-4">
    <form class="row g-3 align-items-end" onsubmit="return false;">

        <!-- Search -->
        <div class="col-md-3">
            <label class="form-label small text-muted">ค้นหา</label>
            <div class="input-group">
                <span class="input-group-text bg-white text-muted">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="searchInput" class="form-control"
                       placeholder="รหัส / หัวข้อ / ผู้แจ้ง">
            </div>
        </div>

        <!-- Status -->
        <div class="col-md-2">
            <label class="form-label small text-muted">สถานะ</label>
            <select id="statusFilter" class="form-select">
                <option value="">ทุกสถานะ</option>
                <option value="รอดำเนินการ">รอดำเนินการ</option>
                <option value="รออนุมัติ">รออนุมัติ</option>
                <option value="ดราฟ">ดราฟ</option>
                <option value="เสร็จสิ้นแล้ว">เสร็จสิ้นแล้ว</option>
            </select>
        </div>

        <!-- Assignee -->
        <div class="col-md-3">
            <label class="form-label small text-muted">ผู้รับผิดชอบ</label>
            <select id="assigneeFilter" class="form-select">
                <option value="">ทุกคน</option>
                {% for t in tickets %}
                {% if t.assignee != "ยังไม่มอบหมาย" %}
                <option value="{{ t.assignee }}">{{ t.assignee }}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>

        <!-- Date -->
        <div class="col-md-3">
            <label class="form-label small text-muted">ช่วงวันที่</label>
            <div class="input-group">
                <span class="input-group-text bg-white text-muted">
                    <i class="fas fa-calendar-alt"></i>
                </span>
                <input type="text" id="dateRange" class="form-control"
                       placeholder="เลือกช่วงวันที่" autocomplete="off">
            </div>
        </div>

    </form>
</div>

<!-- ================= TABLE ================= -->
<div class="dashboard-table overflow-hidden">
<div class="table-responsive">
<table class="table table-hover align-middle mb-0">

<thead>
<tr>
    <th class="text-center" style="width:90px;">รหัส</th>
    <th>ผู้แจ้ง</th>
    <th>หมวดหมู่</th>
    <th>รายละเอียดคำขอ</th>
    <th>วันที่</th>
    <th class="text-center">สถานะ</th>
    <th>ผู้รับผิดชอบ</th>
    <th class="text-end pe-4"></th>
</tr>
</thead>

<tbody id="ticketTableBody">
{% for t in tickets %}
<tr>
    <!-- รหัส -->
    <td class="text-center">
        <span class="badge bg-light text-muted border">#{{ t.id }}</span>
    </td>

    <!-- ผู้แจ้ง -->
    <td>{{ t.requester }}</td>

    <!-- หมวดหมู่ -->
    <td>{{ t.ticket_type }}</td>

    <!-- รายละเอียด -->
    <td>
        <div class="fw-bold">{{ t.title }}</div>
        <small class="text-muted">{{ t.description }}</small>
    </td>

    <!-- วันที่ -->
    <td data-date="{{ t.created_at|date:'Y-m-d' }}">
        {{ t.created_at|date:"d M Y" }}
    </td>

    <!-- สถานะ -->
    <td class="text-center">
        {% if t.status == "รอดำเนินการ" %}
            <span class="badge bg-warning-subtle text-warning">{{ t.status }}</span>
        {% elif t.status == "รออนุมัติ" %}
            <span class="badge bg-info-subtle text-info">{{ t.status }}</span>
        {% elif t.status == "ดราฟ" %}
            <span class="badge bg-light text-dark border">{{ t.status }}</span>
        {% elif t.status == "เสร็จสิ้นแล้ว" %}
            <span class="badge bg-success-subtle text-success">{{ t.status }}</span>
        {% endif %}
    </td>

    <!-- ผู้รับผิดชอบ -->
    <td>
        {% if t.assignee != "ยังไม่มอบหมาย" %}
            {{ t.assignee }}
        {% else %}
            <span class="badge bg-light text-muted border">ยังไม่มอบหมาย</span>
        {% endif %}
    </td>

    <!-- Action -->
    <td class="text-end pe-4">
        <a href="{% url 'tickets_detail' %}?id={{ t.id }}"
           class="btn btn-outline-secondary btn-sm rounded-circle">
            <i class="fas fa-chevron-right"></i>
        </a>
    </td>
</tr>
{% endfor %}
</tbody>

</table>
</div>
</div>

<!-- ================= PAGINATION ================= -->
<div class="d-flex justify-content-between align-items-center mt-3 px-3">
    <div class="small text-muted" id="pageInfo"></div>
    <nav>
        <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
    </nav>
</div>

<!-- ================= JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");
const assigneeFilter = document.getElementById("assigneeFilter");
const dateRange = document.getElementById("dateRange");

const rows = [...document.querySelectorAll("#ticketTableBody tr")];
const pagination = document.getElementById("pagination");
const pageInfo = document.getElementById("pageInfo");

const rowsPerPage = 10;
let currentPage = 1;
let filteredRows = rows;

flatpickr("#dateRange", {
    mode: "range",
    dateFormat: "d/m/Y",
    locale: { rangeSeparator: " ถึง " }
});

function filterTable() {
    const keyword = searchInput.value.toLowerCase();
    const status = statusFilter.value;
    const assignee = assigneeFilter.value;

    let startDate = null, endDate = null;
    if (dateRange.value.includes("ถึง")) {
        const d = dateRange.value.split(" ถึง ");
        startDate = new Date(d[0].split("/").reverse().join("-"));
        endDate = new Date(d[1].split("/").reverse().join("-"));
    }

    filteredRows = rows.filter(row => {
        let show = true;
        const text = row.innerText.toLowerCase();

        if (keyword && !text.includes(keyword)) show = false;
        if (status && !text.includes(status)) show = false;
        if (assignee && !text.includes(assignee)) show = false;

        if (startDate && endDate) {
            const rowDate = new Date(row.querySelector("[data-date]").dataset.date);
            if (rowDate < startDate || rowDate > endDate) show = false;
        }

        return show;
    });

    currentPage = 1;
    render();
}

function render() {
    rows.forEach(r => r.style.display = "none");

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    filteredRows.slice(start, end).forEach(r => r.style.display = "");
    pageInfo.innerText = `แสดง ${filteredRows.length} รายการ`;
    renderPagination();
}

function renderPagination() {
    pagination.innerHTML = "";
    const total = Math.ceil(filteredRows.length / rowsPerPage);
    if (total <= 1) return;

    for (let i = 1; i <= total; i++) {
        const li = document.createElement("li");
        li.className = "page-item" + (i === currentPage ? " active" : "");

        const a = document.createElement("a");
        a.className = "page-link";
        a.href = "#";
        a.innerText = i;
        a.onclick = e => {
            e.preventDefault();
            currentPage = i;
            render();
        };

        li.appendChild(a);
        pagination.appendChild(li);
    }
}

searchInput.onkeyup = filterTable;
statusFilter.onchange = filterTable;
assigneeFilter.onchange = filterTable;
dateRange.onchange = filterTable;

filterTable();
});
</script>

</main>
{% endblock %}
