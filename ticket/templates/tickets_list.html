{% extends "base.html" %}
{% block title %}รายการคำขอทั้งหมด | Ticket System{% endblock %}

{% block content %}

<!-- ================= HEADER ================= -->
<div class="page-header mb-4">
  <h2 class="fw-semibold mb-1">รายการคำขอทั้งหมด</h2>
  <p class="text-muted mb-0">ระบบจัดการ Ticket ภายในองค์กร</p>
</div>

<!-- ================= FILTER ================= -->
<div class="filter-panel mb-4">
  <div class="row g-3 align-items-end">

    <!-- สถานะ -->
    <div class="col-md-3">
      <label class="form-label">สถานะ</label>
      <select id="statusFilter" class="form-select">
        <option value="">ทั้งหมด</option>
        <option>รอดำเนินการ</option>
        <option>รออนุมัติ</option>
        <option>ดราฟ</option>
        <option>เสร็จสิ้นแล้ว</option>
      </select>
    </div>

    <!-- ผู้รับผิดชอบ -->
    <div class="col-md-3">
      <label class="form-label">ผู้รับผิดชอบ</label>
      <select id="assigneeFilter" class="form-select">
        <option value="">ทั้งหมด</option>
        {% for t in tickets %}
          {% if t.assignee != "ยังไม่มอบหมาย" %}
            <option>{{ t.assignee }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </div>

    <!-- ช่วงวันที่ -->
    <div class="col-md-4">
      <label class="form-label">ช่วงวันที่</label>
      <div class="input-group">
        <input type="date" id="startDate" class="form-control">
        <span class="input-group-text bg-white text-muted">ถึง</span>
        <input type="date" id="endDate" class="form-control">
      </div>
    </div>
    
    <!-- ค้นหา -->
    <div class="col-md-2">
      <label class="form-label">ค้นหา</label>
      <input type="search" id="globalSearch" class="form-control"
             placeholder="รหัส / หัวข้อ / ผู้แจ้ง">
    </div>

  </div>
</div>

<!-- ================= TABLE ================= -->
<div class="table-card">
  <div class="table-responsive">
    <table id="ticketTable" class="table table-hover align-middle w-100">

      <thead>
        <tr>
          <th style="width:90px">รหัส</th>
          <th>ผู้แจ้ง</th>
          <th>หมวด</th>
          <th>รายละเอียด</th>
          <th>วันที่</th>
          <th>สถานะ</th>
          <th>ผู้รับผิดชอบ</th>
          <th style="width:60px"></th>
        </tr>
      </thead>

      <tbody>
      {% for t in tickets %}
        <tr class="clickable-row"
            data-href="{% url 'tickets_detail' %}?id={{ t.id }}">

          <td class="text-center">
            <span class="badge bg-light text-dark">#{{ t.id }}</span>
          </td>

          <td>{{ t.requester }}</td>
          <td>{{ t.ticket_type }}</td>

          <td>
            <div class="fw-semibold">{{ t.title }}</div>
            <small class="text-muted">{{ t.description }}</small>
          </td>

          <!-- ใช้ ISO date สำหรับ filter -->
          <td data-date="{{ t.created_at|date:'Y-m-d' }}">
            {{ t.created_at|date:"d M Y" }}
          </td>

          <td>
            {% if t.status == "รอดำเนินการ" %}
              <span class="badge-status status-pending">{{ t.status }}</span>
            {% elif t.status == "รออนุมัติ" %}
              <span class="badge-status status-approve">{{ t.status }}</span>
            {% elif t.status == "ดราฟ" %}
              <span class="badge-status status-draft">{{ t.status }}</span>
            {% else %}
              <span class="badge-status status-done">{{ t.status }}</span>
            {% endif %}
          </td>

          <td>
            {% if t.assignee != "ยังไม่มอบหมาย" %}
              <span class="assignee-pill">{{ t.assignee }}</span>
            {% else %}
              <span class="assignee-pill text-muted">ยังไม่มอบหมาย</span>
            {% endif %}
          </td>

          <!-- ลูกศรยังมีได้ แต่ไม่จำเป็น -->
          <td class="text-end">
            <a href="{% url 'tickets_detail' %}?id={{ t.id }}"
               class="action-btn">
              <i class="fas fa-chevron-right"></i>
            </a>
          </td>
        </tr>
      {% endfor %}
      </tbody>

    </table>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function () {

  // ===== DataTable (ไม่มี search) =====
  const table = $('#ticketTable').DataTable({
    pageLength: 10,
    lengthChange: false,
    searching: false,     // ❌ ปิด search ทั้งหมด
    order: [[4, 'desc']],
    language: {
      zeroRecords: "ไม่พบข้อมูล",
      info: "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
      infoEmpty: "ไม่มีข้อมูล",
      paginate: {
        previous: "ก่อนหน้า",
        next: "ถัดไป"
      }
    }
  });

  // ===== Filter: สถานะ =====
  $('#statusFilter').on('change', function () {
    table.column(5).search(this.value).draw();
  });

  // ===== Filter: ผู้รับผิดชอบ =====
  $('#assigneeFilter').on('change', function () {
    table.column(6).search(this.value).draw();
  });

  // ===== Filter: วันที่ =====
  $.fn.dataTable.ext.search.push(function (settings, data, index) {
    const start = $('#startDate').val();
    const end = $('#endDate').val();

    const row = table.row(index).node();
    const rowDate = $('td[data-date]', row).data('date');

    if (!start && !end) return true;
    if (start && rowDate < start) return false;
    if (end && rowDate > end) return false;

    return true;
  });

  $('#startDate, #endDate').on('change', function () {
    table.draw();
  });

  // ===== Click ทั้งแถว =====
  $('#ticketTable tbody').on('click', 'tr.clickable-row', function (e) {
    if ($(e.target).closest('a, button, input, select').length) return;
    window.location = $(this).data('href');
  });

});
</script>
{% endblock %}
