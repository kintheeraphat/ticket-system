{% extends "base.html" %}
{% load tz %}
{% block title %}รายการคำขอทั้งหมด | Ticket System{% endblock %}

{% block content %}
<main class="main-content">

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">

    <style>
        #ticketTable tbody tr {
            cursor: pointer;
        }

        #ticketTable tbody tr:hover {
            background-color: #f9fafb;
        }

        .ticket-type-box small {
            font-size: 0.75rem;
        }
    </style>

    <!-- ================= HEADER ================= -->
    <div class="d-flex justify-content-between align-items-center mb-4 pt-2">
        <div>
            <h2 class="fw-bold mb-1">รายการคำขอทั้งหมด</h2>
            <p class="text-muted small mb-0">
                ตรวจสอบและบริหารจัดการสถานะรายการแจ้งซ่อมหรือคำร้องขอภายในระบบ
            </p>
        </div>
    </div>

    <!-- ================= FILTER ================= -->
    <div class="dashboard-table mb-4">
        <form class="row g-3 align-items-end" onsubmit="return false;">

            <div class="col-md-2">
                <label class="form-label small text-muted">สถานะ</label>
                <select id="statusFilter" class="form-select">
                    <option value="">ทุกสถานะ</option>
                    <option value="รอดำเนินการ">รอดำเนินการ</option>
                    <option value="รออนุมัติ">รออนุมัติ</option>
                    <option value="ดราฟ">ดราฟ</option>
                    <option value="เสร็จสิ้นแล้ว">เสร็จสิ้นแล้ว</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label small text-muted">ผู้รับผิดชอบ</label>
                <select id="assigneeFilter" class="form-select">
                    <option value="">ทุกคน</option>
                    {% for t in tickets %}
                    {% if t.assignee != "ยังไม่มอบหมาย" %}
                    <option value="{{ t.assignee }}">{{ t.assignee }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label small text-muted">ช่วงเวลา</label>
                <select id="quickDateFilter" class="form-select">
                    <option value="">เดือนปัจจุบัน</option>
                    <option value="7">7 วันที่แล้ว</option>
                    <option value="14">14 วันที่แล้ว</option>
                    <option value="last_month">เดือนที่แล้ว</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label small text-muted">จากวันที่</label>
                <input type="date" id="startDate" class="form-control">
            </div>

            <div class="col-md-2">
                <label class="form-label small text-muted">ถึงวันที่</label>
                <input type="date" id="endDate" class="form-control">
            </div>

            <div class="col-md-1">
                <button id="clearFilters" class="btn btn-outline-secondary w-100">
                    ล้าง
                </button>
            </div>

        </form>
    </div>

    <!-- ================= TABLE ================= -->
    <div class="dashboard-table overflow-hidden">
        <div class="table-responsive">

            <table id="ticketTable" class="table table-hover align-middle mb-0">

                <thead>
                    <tr>
                        <th class="text-center">#</th>
                        <th>ผู้แจ้ง</th>
                        <th>หมวดหมู่</th>
                        <th>รายละเอียดคำขอ</th>
                        <th>วันที่</th>
                        <th class="text-center">สถานะ</th>
                        <th>ผู้รับผิดชอบ</th>
                        <th></th>
                    </tr>
                </thead>

                <tbody>
                    {% for t in tickets %}
                    <!-- <tr data-href="{% url 'tickets_detail_erp' t.id %}"> -->


                        <td class="text-center fw-bold text-muted">#{{ t.id }}</td>

                        <td>
                            <div class="fw-semibold">{{ t.requester }}</div>
                            {% if t.department %}
                            <small class="text-muted">{{ t.department }}</small>
                            {% endif %}
                        </td>

                        <td>
                            <div class="ticket-type-box">
                                <div class="fw-semibold">{{ t.category }}</div>
                                <small class="text-muted">{{ t.ticket_type }}</small>
                            </div>
                        </td>

                        <td>
                            <div class="fw-bold">{{ t.title }}</div>
                        </td>

                        <td data-date="{{ t.created_at|localtime|date:'Y-m-d H:i:s' }}">
                            <div>{{ t.created_at|localtime|date:"d M Y" }}</div>
                            <small class="text-muted">
                                {{ t.created_at|localtime|date:"H:i" }} น.
                            </small>
                        </td>

                        <td class="text-center">
                            <span class="badge-status
            {% if t.status == 'รอดำเนินการ' %}status-pending
            {% elif t.status == 'รออนุมัติ' %}status-approve
            {% elif t.status == 'ดราฟ' %}status-draft
            {% else %}status-done{% endif %}">
                                {{ t.status }}
                            </span>
                        </td>

                        <td>
                            {% if t.assignee %}
                            <span class="assignee-pill">{{ t.assignee }}</span>
                            {% else %}
                            <small class="text-muted">ยังไม่มอบหมาย</small>
                            {% endif %}
                        </td>

                        <td class="text-end">
    <a href="
        {% if t.ticket_type == 1 %}
            {% url 'tickets_detail_erp' t.id %}
        {% elif t.ticket_type == 2 %}
            {% url 'tickets_detail_vpn' t.id %}
        {% endif %}
    " class="action-btn">
        <i class="fas fa-chevron-right"></i>
    </a>
</td>


                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>
    </div>

    <!-- ================= JS (เดิม ไม่แตะ) ================= -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $(function () {

            const today = new Date();

            $.fn.dataTable.ext.search.push(function (settings, data, index) {

                const row = settings.aoData[index].nTr;
                const dateStr = $(row).find('[data-date]').data('date');
                if (!dateStr) return true;

                const rowDate = new Date(dateStr.replace(' ', 'T'));
                const quick = $('#quickDateFilter').val();
                const startVal = $('#startDate').val();
                const endVal = $('#endDate').val();

                // เลือกช่วงวันที่เอง
                if (startVal || endVal) {
                    const start = startVal ? new Date(startVal + ' 00:00:00') : null;
                    const end = endVal ? new Date(endVal + ' 23:59:59') : null;
                    if (start && rowDate < start) return false;
                    if (end && rowDate > end) return false;
                    return true;
                }

                // เดือนปัจจุบัน
                if (quick === "") {
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59);
                    return rowDate >= startOfMonth && rowDate <= endOfMonth;
                }

                // 7 / 14 วัน
                if (quick === "7" || quick === "14") {
                    const days = parseInt(quick);
                    const from = new Date();
                    from.setDate(today.getDate() - days);
                    return rowDate >= from && rowDate <= today;
                }

                // เดือนที่แล้ว
                if (quick === "last_month") {
                    const startOfLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0, 23, 59, 59);
                    return rowDate >= startOfLastMonth && rowDate <= endOfLastMonth;
                }

                return true;
            });

            const table = $('#ticketTable').DataTable({
                pageLength: 10,
                order: [[4, 'desc']],
                language: { zeroRecords: "ไม่พบข้อมูล" }
            });

            $('#ticketTable tbody').on('click', 'tr', function (e) {
                if ($(e.target).closest('a,button').length) return;
                window.location = $(this).data('href');
            });

            $('#statusFilter').on('change', () => table.column(5).search($('#statusFilter').val()).draw());
            $('#assigneeFilter').on('change', () => table.column(6).search($('#assigneeFilter').val()).draw());

            $('#quickDateFilter').on('change', function () {
                $('#startDate,#endDate').val('');
                table.draw();
            });

            $('#startDate,#endDate').on('change', function () {
                $('#quickDateFilter').val('');
                table.draw();
            });

            $('#clearFilters').on('click', function () {
                $('#statusFilter,#assigneeFilter,#quickDateFilter,#startDate,#endDate').val('');
                table.search('').columns().search('');
                table.draw();
            });

            table.draw();
        });
    </script>

</main>
{% endblock %}