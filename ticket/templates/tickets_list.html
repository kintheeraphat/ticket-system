{% extends "base.html" %}
{% block title %}รายการคำขอทั้งหมด | Ticket System{% endblock %}

{% block content %}
<main class="main-content">

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 pt-2">
        <div>
            <h2 class="fw-bold text-dark mb-1">รายการคำขอทั้งหมด</h2>
            <p class="text-muted small mb-0">
                ตรวจสอบและบริหารจัดการสถานะรายการแจ้งซ่อมหรือคำร้องขอภายในระบบ
            </p>
        </div>
    </div>

    <!-- Filter -->
    <div class="dashboard-table mb-4 p-4">
        <form class="row g-3 align-items-end" onsubmit="return false;">

            <!-- Search -->
            <div class="col-md-3">
                <label class="form-label small text-muted">ค้นหา</label>
                <div class="input-group">
                    <span class="input-group-text bg-white text-muted">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="searchInput" class="form-control" placeholder="รหัส / หัวข้อเรื่อง">
                </div>
            </div>

            <!-- Status -->
            <div class="col-md-2">
                <label class="form-label small text-muted">สถานะ</label>
                <select id="statusFilter" class="form-select">
                    <option value="">ทุกสถานะ</option>
                    <option value="รอดำเนินการ">รอดำเนินการ</option>
                    <option value="รออนุมัติ">รออนุมัติ</option>
                    <option value="ดราฟ">ดราฟ</option>
                    <option value="เสร็จสิ้นแล้ว">เสร็จสิ้นแล้ว</option>
                </select>
            </div>

            <!-- Assignee -->
            <div class="col-md-3">
                <label class="form-label small text-muted">ผู้รับผิดชอบงาน</label>
                <select id="assigneeFilter" class="form-select">
                    <option value="">ทุกคน</option>
                    {% for ticket in tickets %}
                    {% if ticket.assignee != "ยังไม่มอบหมาย" %}
                    <option value="{{ ticket.assignee }}">{{ ticket.assignee }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>

            <!-- Date range -->
            <div class="col-md-3">
                <label class="form-label small text-muted">ช่วงวันที่</label>
                <div class="input-group">
                    <span class="input-group-text bg-white text-muted">
                        <i class="fas fa-calendar-alt"></i>
                    </span>
                    <input type="text" id="dateRange" class="form-control" placeholder="เลือกช่วงวันที่"
                        autocomplete="off">
                </div>
            </div>

        </form>
    </div>

    <!-- Table -->
    <div class="dashboard-table overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">

                <thead>
                    <tr>
                        <th class="text-center" style="width:100px;">รหัสรายการ</th>
                        <th>รายละเอียดคำขอ</th>
                        <th>หมวดหมู่</th>
                        <th>ผู้แจ้งเรื่อง</th>
                        <th>ผู้รับผิดชอบงาน</th>
                        <th>วันที่ส่งคำขอ</th>
                        <th class="text-center">สถานะ</th>
                        <th class="text-end pe-4">การจัดการ</th>
                    </tr>
                </thead>

                <tbody id="ticketTableBody">
                    {% for t in tickets %}
                    <tr>
                        <td class="text-center">#{{ t.id }}</td>
                        <td>
                            <div class="fw-bold">{{ t.title }}</div>
                            <small>{{ t.description }}</small>
                        </td>
                        <td>{{ t.ticket_type }}</td>
                        <td>{{ t.requester }}</td>
                        <td>{{ t.assignee }}</td>
                        <td data-date="{{ t.created_at|date:'Y-m-d' }}">
                            {{ t.created_at|date:"d M Y" }}
                        </td>
                        <td class="text-center">{{ t.status }}</td>
                        <td class="text-end pe-4">
                            <a href="{% url 'tickets_detail' %}?id={{ t.id }}"
                                class="btn btn-outline-secondary btn-sm rounded-circle">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-3 px-3">
        <div class="small text-muted" id="pageInfo"></div>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>

    <!-- Flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Filter + Pagination JS -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const searchInput = document.getElementById("searchInput");
            const statusFilter = document.getElementById("statusFilter");
            const assigneeFilter = document.getElementById("assigneeFilter");
            const dateRange = document.getElementById("dateRange");

            const rows = Array.from(document.querySelectorAll("#ticketTableBody tr"));
            const pagination = document.getElementById("pagination");
            const pageInfo = document.getElementById("pageInfo");

            const rowsPerPage = 10;
            let currentPage = 1;
            let filteredRows = rows;

            function filterTable() {
                const keyword = searchInput.value.toLowerCase();
                const status = statusFilter.value;
                const assignee = assigneeFilter.value;

                let startDate = null;
                let endDate = null;

                if (dateRange.value.includes("ถึง")) {
                    const dates = dateRange.value.split(" ถึง ");
                    startDate = new Date(dates[0].split("/").reverse().join("-"));
                    endDate = new Date(dates[1].split("/").reverse().join("-"));
                }

                filteredRows = rows.filter(row => {
                    const text = row.innerText.toLowerCase();
                    let show = true;

                    if (keyword && !text.includes(keyword)) show = false;
                    if (status && !text.includes(status)) show = false;
                    if (assignee && !text.includes(assignee)) show = false;

                    if (startDate && endDate) {
                        const rowDate = new Date(row.querySelector("[data-date]").dataset.date);
                        if (rowDate < startDate || rowDate > endDate) show = false;
                    }

                    return show;
                });

                currentPage = 1;
                render();
            }

            function render() {
                rows.forEach(r => r.style.display = "none");

                const start = (currentPage - 1) * rowsPerPage;
                const end = start + rowsPerPage;

                filteredRows.slice(start, end).forEach(r => r.style.display = "");

                pageInfo.innerText = `แสดง ${filteredRows.length} รายการ`;
                renderPagination();
            }

            function renderPagination() {
                pagination.innerHTML = "";
                const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
                if (totalPages <= 1) return;

                /* ===== Prev ===== */
                const prevLi = document.createElement("li");
                prevLi.className = "page-item" + (currentPage === 1 ? " disabled" : "");

                const prevA = document.createElement("a");
                prevA.className = "page-link";
                prevA.href = "#";
                prevA.innerHTML = "&laquo;";

                prevA.onclick = e => {
                    e.preventDefault();
                    if (currentPage > 1) {
                        currentPage--;
                        render();
                    }
                };

                prevLi.appendChild(prevA);
                pagination.appendChild(prevLi);

                /* ===== Page numbers (แบบ DataTables) ===== */
                const maxVisible = 5;
                let start = Math.max(1, currentPage - 2);
                let end = Math.min(totalPages, start + maxVisible - 1);

                if (end - start < maxVisible - 1) {
                    start = Math.max(1, end - maxVisible + 1);
                }

                if (start > 1) {
                    pagination.appendChild(createEllipsis());
                }

                for (let i = start; i <= end; i++) {
                    const li = document.createElement("li");
                    li.className = "page-item" + (i === currentPage ? " active" : "");

                    const a = document.createElement("a");
                    a.className = "page-link";
                    a.href = "#";
                    a.innerText = i;

                    a.onclick = e => {
                        e.preventDefault();
                        currentPage = i;
                        render();
                    };

                    li.appendChild(a);
                    pagination.appendChild(li);
                }

                if (end < totalPages) {
                    pagination.appendChild(createEllipsis());
                }

                /* ===== Next ===== */
                const nextLi = document.createElement("li");
                nextLi.className = "page-item" + (currentPage === totalPages ? " disabled" : "");

                const nextA = document.createElement("a");
                nextA.className = "page-link";
                nextA.href = "#";
                nextA.innerHTML = "&raquo;";

                nextA.onclick = e => {
                    e.preventDefault();
                    if (currentPage < totalPages) {
                        currentPage++;
                        render();
                    }
                };

                nextLi.appendChild(nextA);
                pagination.appendChild(nextLi);
            }

            function createEllipsis() {
                const li = document.createElement("li");
                li.className = "page-item disabled";
                li.innerHTML = `<span class="page-link">…</span>`;
                return li;
            }



            searchInput.onkeyup = filterTable;
            statusFilter.onchange = filterTable;
            assigneeFilter.onchange = filterTable;
            dateRange.onchange = filterTable;

            flatpickr("#dateRange", {
                mode: "range",
                dateFormat: "d/m/Y",
                locale: { rangeSeparator: " ถึง " }
            });

            filterTable();
        });
    </script>

</main>
{% endblock %}